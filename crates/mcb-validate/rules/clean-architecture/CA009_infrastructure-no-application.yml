schema: "rule/v1"
id: "CA009"
name: "Infrastructure Must Not Import Application"
category: "architecture"
severity: "error"
enabled: true
engine: "rusty-rules"

description: "Infrastructure layer should NOT depend on Application layer"

patterns:
  app_import: 'use\s+{{application_module}}(?:::|;)'
  app_import_path: 'use\s+({{application_module}}::\S+)'
rationale: |
  Per Clean Architecture, infrastructure layer ({{infrastructure_crate}}) should only
  depend on {{domain_crate}} (for port traits).

  It should NOT depend on {{application_crate}}, {{providers_crate}}, or {{server_crate}} as this
  creates circular dependencies and layer violations.

fix_guidance: |
  1. If importing port traits: Move them to {{domain_crate}}/src/ports/
  2. If importing services: Use DI with Arc<dyn ServiceTrait>
  3. If importing registry: Access via {{providers_crate}}, not directly

crate_name: "{{infrastructure_crate}}"
forbidden_imports:
  - "{{application_module}}"

config:
  composition_root_skip_patterns: ["/di/"]

rule: |
  rule InfrastructureNoApplication "Infrastructure Must Not Import Application" {
      when
          Crate(name == "{{infrastructure_crate}}") &&
          Import(path starts_with "{{application_module}}")
      then
          Violation("Infrastructure layer cannot depend on Application layer - violates Clean Architecture");
  }
