schema: "rule/v1"
id: "CA017"
name: "Dependency Injection Patterns"
category: "architecture"
severity: "warning"
enabled: true
engine: "rust-rule-engine"

description: "Uses Arc<dyn Trait> for dependency injection instead of Arc<ConcreteType>"
rationale: "Trait objects allow for easier testing and decoupled implementations"

patterns:
  arc_pattern: "Arc<([A-Z][a-zA-Z0-9_]*)>"

config:
  allowed_concrete_types:
    - "String"
    - "Mutex"
    - "RwLock"
    - "AtomicBool"
    - "AtomicUsize"
    - "AtomicU32"
    - "AtomicU64"
    - "AtomicI32"
    - "AtomicI64"
    - "Notify"
    - "Barrier"
    - "Semaphore"
    - "Once"
    - "CryptoService"
    - "ToolHandler"
    - "ResourceHandler"
    - "PromptHandler"
    - "AdminHandler"
    - "ToolRouter"
  provider_trait_suffixes:
    - "Provider"
    - "Service"
    - "Repository"
    - "Interface"

rule: |
  rule DependencyInjectionPatterns "DI Patterns" {
      when
          Arc(inner_type == ConcreteType) &&
          !AllowedConcrete(inner_type) &&
          HasProviderSuffix(inner_type)
      then
          Violation("Concrete type in DI: use Arc<dyn Trait> instead");
  }
