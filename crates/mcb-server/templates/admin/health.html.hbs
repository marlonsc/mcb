{{#*inline "head_extra"}}
    <script src="https://unpkg.com/hyperscript.org@0.9.12"></script>
    <style>
        .status-badge { display: inline-flex; align-items: center; padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.875rem; font-weight: 500; }
        .status-healthy { background: var(--color-success-bg); color: var(--color-success-text); }
        .status-degraded { background: var(--color-warning-bg); color: var(--color-warning-text); }
        .status-unhealthy { background: var(--color-error-bg); color: var(--color-error-text); }
        .status-unknown { background: var(--bg-tertiary); color: var(--text-primary); }
        .dependency-row { display: flex; justify-content: space-between; align-items: center; padding: 0.75rem 0; border-bottom: 1px solid var(--border-color); }
        .dependency-row:last-child { border-bottom: none; }
    </style>
{{/inline}}

{{#*inline "page"}}
<div class="mb-8 flex justify-between items-center">
    <div>
        <h1 class="text-3xl font-bold">Health Status</h1>
        <p class="mt-2 text-secondary">System health and dependency status</p>
    </div>
    <button class="btn btn-secondary" hx-get="/health/extended" hx-target="#health-content" hx-swap="innerHTML">Refresh</button>
</div>

<div id="health-content" hx-get="/health/extended" hx-trigger="load, every 10s" hx-swap="innerHTML">
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div class="card animate-pulse">
            <div class="h-6 rounded w-1/3 mb-4" style="background: var(--bg-tertiary)"></div>
            <div class="h-16 rounded" style="background: var(--bg-tertiary)"></div>
        </div>
        <div class="card animate-pulse">
            <div class="h-6 rounded w-1/3 mb-4" style="background: var(--bg-tertiary)"></div>
            <div class="h-16 rounded" style="background: var(--bg-tertiary)"></div>
        </div>
    </div>
</div>

<div class="mt-8 grid grid-cols-1 md:grid-cols-2 gap-6">
    <div class="card">
        <h2 class="text-lg font-semibold mb-4">Readiness Probe</h2>
        <div id="ready-status" hx-get="/ready" hx-trigger="load, every 10s">
            <div class="animate-pulse h-8 rounded" style="background: var(--bg-tertiary)"></div>
        </div>
    </div>
    <div class="card">
        <h2 class="text-lg font-semibold mb-4">Liveness Probe</h2>
        <div id="live-status" hx-get="/live" hx-trigger="load, every 10s">
            <div class="animate-pulse h-8 rounded" style="background: var(--bg-tertiary)"></div>
        </div>
    </div>
</div>
{{/inline}}

{{#*inline "page_scripts"}}
<script>
    document.body.addEventListener('htmx:afterSwap', function(evt) {
        if (evt.detail.target.id === 'health-content') {
            try {
                var data = parseJsonSafe(evt.detail.xhr.responseText, {});
                var safeStatus = ['healthy','degraded','unhealthy','unknown'].indexOf(String(data.status||'').toLowerCase()) >= 0 ? String(data.status).toLowerCase() : 'unknown';
                var html = '<div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">' +
                    '<div class="card"><h2 class="text-lg font-semibold mb-4">Overall Status</h2>' +
                    '<div class="flex items-center justify-between"><span class="status-badge status-' + safeStatus + '">' + escapeHtml(String(data.status||'').toUpperCase()) + '</span>' +
                    '<span class="text-secondary">Uptime: ' + formatUptime(toIntegerSafe(data.uptime_seconds,0)) + '</span></div></div>' +
                    '<div class="card"><h2 class="text-lg font-semibold mb-4">Active Operations</h2>' +
                    '<p class="text-3xl font-semibold">' + toIntegerSafe(data.active_indexing_operations,0) + '</p>' +
                    '<p class="text-secondary text-sm">indexing operations in progress</p></div></div>';
                var deps = toArraySafe(data.dependencies);
                if (deps.length > 0) {
                    html += '<div class="card"><h2 class="text-lg font-semibold mb-4">Dependencies</h2><div>';
                    deps.forEach(function(dep) {
                        var ds = ['healthy','degraded','unhealthy','unknown'].indexOf(String(dep.status||'').toLowerCase()) >= 0 ? String(dep.status).toLowerCase() : 'unknown';
                        html += '<div class="dependency-row"><div><p class="font-medium">' + escapeHtml(dep.name||'') + '</p>' +
                            (dep.message ? '<p class="text-sm text-secondary">' + escapeHtml(dep.message) + '</p>' : '') +
                            '</div><span class="status-badge status-' + ds + '">' + escapeHtml(String(dep.status||'')) + '</span></div>';
                    });
                    html += '</div></div>';
                } else {
                    html += '<div class="card"><h2 class="text-lg font-semibold mb-4">Dependencies</h2><p class="text-secondary">No dependencies registered for health checking</p></div>';
                }
                document.getElementById('health-content').innerHTML = html;
            } catch(e) {}
        }
        if (evt.detail.target.id === 'ready-status') {
            try {
                var data = parseJsonSafe(evt.detail.xhr.responseText, {});
                var ready = Boolean(data.ready);
                document.getElementById('ready-status').innerHTML = '<span class="status-badge ' + (ready?'status-healthy':'status-unhealthy') + '">' + (ready?'READY':'NOT READY') + '</span>' +
                    '<p class="text-sm text-secondary mt-2">Uptime: ' + formatUptime(toIntegerSafe(data.uptime_seconds,0)) + '</p>';
            } catch(e) {}
        }
        if (evt.detail.target.id === 'live-status') {
            try {
                var data = parseJsonSafe(evt.detail.xhr.responseText, {});
                var alive = Boolean(data.alive);
                document.getElementById('live-status').innerHTML = '<span class="status-badge ' + (alive?'status-healthy':'status-unhealthy') + '">' + (alive?'ALIVE':'NOT ALIVE') + '</span>' +
                    '<p class="text-sm text-secondary mt-2">Uptime: ' + formatUptime(toIntegerSafe(data.uptime_seconds,0)) + '</p>';
            } catch(e) {}
        }
    });
</script>
{{/inline}}

{{> admin/layout}}
