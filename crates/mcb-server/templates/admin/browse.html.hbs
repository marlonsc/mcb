{{#*inline "head_extra"}}
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.3/dist/cdn.min.js"></script>
    <style>
        .entity-item { border: 1px solid var(--border-color); border-radius: 0.5rem; padding: 0.75rem; margin-bottom: 0.75rem; }
        .entity-item:last-child { margin-bottom: 0; }
        .entity-item.active { border-color: var(--accent); box-shadow: 0 0 0 1px var(--accent); }
    </style>
{{/inline}}

{{#*inline "page"}}
<div class="mb-8">
    <h1 class="text-3xl font-bold text-primary">Browse Indexed Code</h1>
    <p class="mt-2 text-secondary">Explore collections and workflow entities with linked navigation</p>
</div>

<div class="card mb-8">
    <div class="flex items-center justify-between mb-4">
        <h2 class="text-lg font-semibold text-primary">Workflow Entity Graph</h2>
        <button class="btn btn-secondary" onclick="loadWorkflowGraph()">Refresh Graph</button>
    </div>
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
        <div>
            <h3 class="text-sm font-medium text-secondary uppercase tracking-wider mb-2">Projects</h3>
            <div id="projects-list" class="card" style="padding: 0.75rem; min-height: 12rem;">
                <p class="text-secondary text-sm">Loading projects...</p>
            </div>
        </div>
        <div>
            <h3 class="text-sm font-medium text-secondary uppercase tracking-wider mb-2">Phases</h3>
            <div id="phases-list" class="card" style="padding: 0.75rem; min-height: 12rem;">
                <p class="text-secondary text-sm">Select a project</p>
            </div>
        </div>
        <div>
            <h3 class="text-sm font-medium text-secondary uppercase tracking-wider mb-2">Issues</h3>
            <div id="issues-list" class="card" style="padding: 0.75rem; min-height: 12rem;">
                <p class="text-secondary text-sm">Select a project or phase</p>
            </div>
        </div>
    </div>
</div>

<div id="collections-container">
    <div class="flex items-center justify-between mb-4">
        <h2 class="text-lg font-semibold text-primary">Collections</h2>
        <button class="btn btn-primary" onclick="loadCollections()">Refresh</button>
    </div>
    <div id="collections-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        <div class="card flex items-center justify-center h-32">
            <p class="text-secondary">Loading collections...</p>
        </div>
    </div>
</div>
{{/inline}}

{{#*inline "page_scripts"}}
<script>
    var workflowProjects = [], workflowPhases = [], workflowIssues = [];
    var selectedProjectId = '', selectedPhaseId = '';
    var knownCollections = [];

    function formatNumber(num) { var n = toNumberSafe(num,0); if(n>=1e6) return (n/1e6).toFixed(1)+'M'; if(n>=1000) return (n/1000).toFixed(1)+'K'; return n.toString(); }
    function formatTimestamp(ts) { return new Date(toNumberSafe(ts,0)*1000).toLocaleString(); }

    async function loadCollections() {
        var grid = document.getElementById('collections-grid');
        grid.innerHTML = '<div class="card flex items-center justify-center h-32"><p class="text-secondary">Loading...</p></div>';
        try {
            var resp = await adminFetch('/collections');
            if (!resp.ok) throw new Error('HTTP ' + resp.status);
            var data = await resp.json();
            knownCollections = toArraySafe(data && data.collections);
            renderCollections(knownCollections);
        } catch(e) {
            grid.innerHTML = '<div class="card flex flex-col items-center justify-center h-32 col-span-full"><p class="text-red-500 font-medium">Error loading collections</p><p class="text-secondary text-sm mt-2">'+escapeHtml(e.message)+'</p></div>';
        }
    }

    function renderCollections(collections) {
        var grid = document.getElementById('collections-grid');
        if (!collections || collections.length === 0) {
            grid.innerHTML = '<div class="card flex flex-col items-center justify-center h-32 col-span-full"><p class="text-secondary font-medium">No collections found</p><p class="text-secondary text-sm mt-2">Index a codebase to see it here.</p></div>';
            return;
        }
        grid.innerHTML = collections.map(function(c) {
            return '<a href="/ui/browse/' + encodeURIComponent(c.name) + '" class="card block hover:shadow-md transition-shadow">' +
                '<div class="flex items-start justify-between"><div>' +
                '<h3 class="text-lg font-semibold text-primary">' + escapeHtml(c.name) + '</h3>' +
                '<p class="text-sm text-secondary mt-1">' + escapeHtml(c.provider) + '</p></div>' +
                '<svg class="w-5 h-5 text-muted" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg></div>' +
                '<div class="mt-4 grid grid-cols-2 gap-4"><div><p class="stat-value">' + formatNumber(c.vector_count) + '</p><p class="stat-label">Vectors</p></div>' +
                '<div><p class="stat-value">' + formatNumber(c.file_count) + '</p><p class="stat-label">Files</p></div></div>' +
                (c.last_indexed ? '<p class="text-xs text-muted mt-4">Last indexed: ' + formatTimestamp(c.last_indexed) + '</p>' : '') +
                '</a>';
        }).join('');
    }

    async function loadWorkflowGraph() {
        document.getElementById('projects-list').innerHTML = '<p class="text-secondary text-sm">Loading projects...</p>';
        document.getElementById('phases-list').innerHTML = '<p class="text-secondary text-sm">Select a project</p>';
        document.getElementById('issues-list').innerHTML = '<p class="text-secondary text-sm">Select a project or phase</p>';
        try {
            var resp = await adminFetch('/projects');
            if (!resp.ok) throw new Error('HTTP ' + resp.status);
            var data = await resp.json();
            workflowProjects = toArraySafe(data && data.projects);
            selectedProjectId = ''; selectedPhaseId = '';
            renderProjects();
        } catch(e) {
            document.getElementById('projects-list').innerHTML = '<p class="text-red-500 text-sm">Failed to load projects: ' + escapeHtml(e.message) + '</p>';
        }
    }

    function renderProjects() {
        var el = document.getElementById('projects-list');
        if (workflowProjects.length === 0) { el.innerHTML = '<p class="text-secondary text-sm">No workflow projects found.</p>'; return; }
        el.innerHTML = workflowProjects.map(function(p) {
            var sel = selectedProjectId === p.id ? ' active' : '';
            var match = knownCollections.find(function(c) { return c.name === p.name; });
            var link = match ? '<a href="/ui/browse/' + encodeURIComponent(match.name) + '" class="text-xs text-primary" style="text-decoration:underline">Open collection</a>'
                : '<a href="/ui/browse" class="text-xs text-secondary" style="text-decoration:underline">Find collection</a>';
            return '<div class="entity-item' + sel + '"><button class="w-full text-left" onclick="selectProject(decodeURIComponent(\'' + encodeURIComponent(String(p.id||'')) + '\'))">' +
                '<p class="font-medium text-primary truncate">' + escapeHtml(p.name||p.id) + '</p>' +
                '<p class="text-xs text-secondary truncate">' + escapeHtml(p.path||'') + '</p></button>' +
                '<div class="mt-2">' + link + '</div></div>';
        }).join('');
    }

    async function selectProject(pid) {
        selectedProjectId = pid; selectedPhaseId = '';
        renderProjects();
        document.getElementById('phases-list').innerHTML = '<p class="text-secondary text-sm">Loading phases...</p>';
        document.getElementById('issues-list').innerHTML = '<p class="text-secondary text-sm">Loading issues...</p>';
        try {
            var resps = await Promise.all([adminFetch('/projects/' + encodeURIComponent(pid) + '/phases'), adminFetch('/projects/' + encodeURIComponent(pid) + '/issues')]);
            if (!resps[0].ok) throw new Error('Failed phases: HTTP ' + resps[0].status);
            if (!resps[1].ok) throw new Error('Failed issues: HTTP ' + resps[1].status);
            var pp = await resps[0].json(); var ip = await resps[1].json();
            workflowPhases = toArraySafe(pp && pp.phases);
            workflowIssues = toArraySafe(ip && ip.issues);
            renderPhases(); renderIssues();
        } catch(e) {
            document.getElementById('phases-list').innerHTML = '<p class="text-red-500 text-sm">' + escapeHtml(e.message) + '</p>';
            document.getElementById('issues-list').innerHTML = '<p class="text-red-500 text-sm">' + escapeHtml(e.message) + '</p>';
        }
    }

    function renderPhases() {
        var el = document.getElementById('phases-list');
        if (workflowPhases.length === 0) { el.innerHTML = '<p class="text-secondary text-sm">No phases for selected project.</p>'; return; }
        el.innerHTML = workflowPhases.map(function(ph) {
            var sel = selectedPhaseId === ph.id ? ' active' : '';
            return '<div class="entity-item' + sel + '"><button class="w-full text-left" onclick="selectPhase(decodeURIComponent(\'' + encodeURIComponent(String(ph.id||'')) + '\'))">' +
                '<p class="font-medium text-primary">' + escapeHtml(ph.name||ph.id) + '</p><p class="text-xs text-secondary">' + escapeHtml(String(ph.status||'')) + '</p></button></div>';
        }).join('');
    }

    function selectPhase(phaseId) { selectedPhaseId = selectedPhaseId === phaseId ? '' : phaseId; renderPhases(); renderIssues(); }

    function renderIssues() {
        var el = document.getElementById('issues-list');
        var filtered = selectedPhaseId !== '' ? workflowIssues.filter(function(i) { return i.phase_id === selectedPhaseId; }) : workflowIssues;
        if (filtered.length === 0) { el.innerHTML = '<p class="text-secondary text-sm">No issues for current selection.</p>'; return; }
        el.innerHTML = filtered.map(function(i) {
            return '<div class="entity-item"><p class="font-medium text-primary truncate">' + escapeHtml(i.title||i.id) + '</p>' +
                '<p class="text-xs text-secondary">' + escapeHtml(String(i.status||'')) + ' Â· P' + toIntegerSafe(i.priority,0) + '</p>' +
                '<p class="text-xs text-muted mt-1 truncate">' + escapeHtml(i.id||'') + '</p></div>';
        }).join('');
    }

    document.addEventListener('DOMContentLoaded', function() { loadCollections(); loadWorkflowGraph(); });
</script>
{{/inline}}

{{> admin/layout}}
