{{#*inline "head_extra"}}
    <script src="https://unpkg.com/htmx-ext-sse@2.2.2/sse.js"></script>
    <script src="https://unpkg.com/hyperscript.org@0.9.12"></script>
    <style>
        .status-healthy { color: #16a34a; }
        .status-degraded { color: #ca8a04; }
        .status-unhealthy { color: #dc2626; }
        .status-running { color: #16a34a; }
        .status-stopped { color: #6b7280; }
        .status-starting { color: #2563eb; }
        .status-stopping { color: #ca8a04; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-success { background: #16a34a; color: white; }
        .btn-success:hover:not(:disabled) { background: #15803d; }
        .btn-warning { background: #ca8a04; color: white; }
        .btn-warning:hover:not(:disabled) { background: #a16207; }
        .btn-danger:hover:not(:disabled) { background: #b91c1c; }
        .sse-indicator { display: inline-block; width: 8px; height: 8px; border-radius: 50%; margin-right: 0.5rem; }
        .sse-connected { background: #16a34a; animation: pulse 2s infinite; }
        .sse-disconnected { background: #dc2626; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .event-log { max-height: 300px; overflow-y: auto; }
        .event-item { border-left: 3px solid; padding: 0.5rem 1rem; margin-bottom: 0.5rem; font-size: 0.875rem; border-radius: 0.375rem; background: var(--bg-secondary); color: var(--text-primary); }
        .event-indexing { border-color: var(--accent); }
        .event-service { border-color: #16a34a; }
        .event-config { border-color: #ca8a04; }
        .event-health { border-color: #8b5cf6; }
        .event-error { border-color: #dc2626; }
        .event-system { border-color: var(--text-muted); }
        .event-log-error { border-color: #ef4444; }
        .event-log-warn { border-color: #f59e0b; }
        .event-log-info { border-color: var(--accent); }
        .event-log-debug { border-color: var(--text-muted); }
        .event-log-trace { border-color: var(--border-color); }
        .event-validation { border-color: #8b5cf6; }
        .log-level { font-weight: 600; font-size: 0.75rem; padding: 0.1rem 0.4rem; border-radius: 0.25rem; }
        .log-level-error { background: rgba(239, 68, 68, 0.15); color: #ef4444; }
        .log-level-warn { background: rgba(245, 158, 11, 0.15); color: #f59e0b; }
        .log-level-info { background: rgba(59, 130, 246, 0.15); color: var(--accent); }
        .log-level-debug { background: var(--bg-tertiary); color: var(--text-secondary); }
        .log-level-trace { background: var(--bg-tertiary); color: var(--text-muted); }
    </style>
{{/inline}}

{{#*inline "page"}}
<div class="mb-8 flex items-center justify-between">
    <div>
        <h1 class="text-3xl font-bold">Dashboard</h1>
        <p class="mt-2 text-secondary">System overview and real-time metrics via SSE</p>
    </div>
    <span id="sse-status" class="flex items-center text-sm">
        <span class="sse-indicator sse-disconnected" id="sse-indicator"></span>
        <span id="sse-text">Disconnected</span>
    </span>
</div>

<div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
    <div class="card">
        <h3 class="text-sm font-medium text-secondary uppercase tracking-wider">Registered Entities</h3>
        <p class="mt-2 text-3xl font-semibold">{{entity_count}}</p>
    </div>
    <div class="card">
        <h3 class="text-sm font-medium text-secondary uppercase tracking-wider">Active Entities</h3>
        <p class="mt-2 text-3xl font-semibold">{{active_entity_count}}</p>
    </div>
    <div class="card">
        <h3 class="text-sm font-medium text-secondary uppercase tracking-wider">Indexed Records</h3>
        <p class="mt-2 text-3xl font-semibold">{{total_records}}</p>
    </div>
</div>

{{#if entity_cards}}
<div class="card mb-8">
    <div class="flex items-center justify-between mb-4">
        <h2 class="text-lg font-semibold">Entity Coverage</h2>
        <a class="btn btn-secondary btn-sm" href="/ui/entities">Open Catalog</a>
    </div>
    <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4">
        {{#each entity_cards}}
        <div class="rounded-lg border p-4" style="border-color: var(--border-color, #e5e7eb)">
            <div class="flex items-center justify-between">
                <h3 class="font-semibold">{{title}}</h3>
                <span class="badge badge-blue">{{group}}</span>
            </div>
            <p class="text-sm text-secondary mt-2">{{field_count}} visible {{pluralize field_count "field" "fields"}}</p>
            <p class="text-sm mt-2"><strong>{{record_count}}</strong> records indexed</p>
            <a class="btn btn-primary btn-sm mt-3" href="/ui/entities/{{slug}}">Manage</a>
        </div>
        {{/each}}
    </div>
</div>
{{/if}}

{{#if recent_activity}}
<div class="card mb-8">
    <h2 class="text-lg font-semibold mb-4">Recent Entity Activity</h2>
    <div class="space-y-3">
        {{#each recent_activity}}
        <div class="flex items-start justify-between gap-4 pb-3 border-b" style="border-color: var(--border-color, #e5e7eb)">
            <div>
                <p class="font-medium">{{entity_title}}</p>
                <p class="text-sm text-secondary">{{record_count}} {{pluralize record_count "record" "records"}} currently indexed</p>
            </div>
            <span class="text-xs text-secondary whitespace-nowrap">{{timestamp timestamp}}</span>
        </div>
        {{/each}}
    </div>
</div>
{{/if}}

<div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
    <div class="card" id="health-card">
        <h3 class="text-sm font-medium text-secondary uppercase tracking-wider">Status</h3>
        <p class="mt-2 text-3xl font-semibold text-muted" id="status-value">Loading...</p>
    </div>
    <div class="card" id="uptime-card">
        <h3 class="text-sm font-medium text-secondary uppercase tracking-wider">Uptime</h3>
        <p class="mt-2 text-3xl font-semibold" id="uptime-value">Loading...</p>
    </div>
    <div class="card" id="active-ops-card">
        <h3 class="text-sm font-medium text-secondary uppercase tracking-wider">Active Operations</h3>
        <p class="mt-2 text-3xl font-semibold" id="active-ops-value">Loading...</p>
    </div>
</div>

<div class="card mb-8" id="metrics-section">
    <h2 class="text-lg font-semibold mb-4">Performance Metrics</h2>
    <div class="grid grid-cols-2 md:grid-cols-4 gap-6">
        <div>
            <p class="text-sm text-secondary">Total Queries</p>
            <p class="text-2xl font-semibold" id="metric-total-queries">Loading...</p>
        </div>
        <div>
            <p class="text-sm text-secondary">Success Rate</p>
            <p class="text-2xl font-semibold" id="metric-success-rate">Loading...</p>
        </div>
        <div>
            <p class="text-sm text-secondary">Cache Hit Rate</p>
            <p class="text-2xl font-semibold" id="metric-cache-hit">Loading...</p>
        </div>
        <div>
            <p class="text-sm text-secondary">Avg Response Time</p>
            <p class="text-2xl font-semibold" id="metric-avg-response">Loading...</p>
        </div>
    </div>
</div>

<div class="card mb-8">
    <div class="flex items-center justify-between mb-4">
        <h2 class="text-lg font-semibold">Services</h2>
        <button class="btn btn-primary btn-sm" onclick="refreshServices()">Refresh</button>
    </div>
    <div id="services-list" class="space-y-3">
        <p class="text-secondary text-sm">Loading services...</p>
    </div>
</div>

<div class="card mb-8">
    <div class="flex items-center justify-between mb-4">
        <h2 class="text-lg font-semibold">Live Event Log</h2>
        <button class="btn btn-sm btn-secondary" onclick="clearEventLog()">Clear</button>
    </div>
    <div id="event-log" class="event-log">
        <p class="text-secondary text-sm text-center py-4">Waiting for events...</p>
    </div>
</div>

<div class="card">
    <h2 class="text-lg font-semibold mb-4">Quick Actions</h2>
    <div class="flex flex-wrap gap-4">
        <button class="btn btn-primary"
                hx-post="/config/reload"
                hx-swap="none"
                hx-confirm="Reload configuration from file?">
            Reload Config
        </button>
        <button class="btn btn-warning" onclick="healthCheckAll()">
            Health Check All
        </button>
        <button class="btn btn-danger"
                hx-post="/shutdown"
                hx-vals='{"timeout_secs": 30}'
                hx-confirm="Are you sure you want to shutdown the server?"
                hx-swap="none">
            Shutdown Server
        </button>
    </div>
</div>
{{/inline}}

{{#*inline "page_scripts"}}
<script>
    var eventSource = null;
    var reconnectAttempts = 0;
    var maxReconnectAttempts = 5;
    var reconnectDelay = 3000;

    function connectSSE() {
        if (eventSource) { eventSource.close(); }
        eventSource = new EventSource('/events');
        eventSource.onopen = function() {
            reconnectAttempts = 0;
            updateSSEStatus(true);
            addEventToLog('system', 'Connected to event stream');
        };
        eventSource.onerror = function() {
            updateSSEStatus(false);
            if (reconnectAttempts < maxReconnectAttempts) {
                reconnectAttempts++;
                addEventToLog('error', 'Connection lost. Reconnecting (' + reconnectAttempts + '/' + maxReconnectAttempts + ')...');
                setTimeout(connectSSE, reconnectDelay);
            } else {
                addEventToLog('error', 'Max reconnect attempts reached. Please refresh the page.');
            }
        };
        ['IndexRebuild','IndexingStarted','IndexingProgress','IndexingCompleted',
         'SyncCompleted','CacheInvalidate','SnapshotCreated','FileChangesDetected',
         'ServiceStateChanged','ConfigReloaded','HealthCheckCompleted',
         'MetricsSnapshot','SearchExecuted','LogEvent',
         'ValidationStarted','ValidationProgress','ValidationCompleted'].forEach(function(eventType) {
            eventSource.addEventListener(eventType, function(e) {
                handleEvent(eventType, parseJsonSafe(e.data, {}));
            });
        });
    }

    function updateSSEStatus(connected) {
        var indicator = document.getElementById('sse-indicator');
        var text = document.getElementById('sse-text');
        if (connected) {
            indicator.classList.remove('sse-disconnected');
            indicator.classList.add('sse-connected');
            text.textContent = 'Live';
        } else {
            indicator.classList.remove('sse-connected');
            indicator.classList.add('sse-disconnected');
            text.textContent = 'Disconnected';
        }
    }

    function handleEvent(eventType, data) {
        // Unwrap serde enum variant: {"EventType": {fields}} â†’ {fields}
        if (data[eventType]) { data = data[eventType]; }
        switch (eventType) {
            case 'ServiceStateChanged':
                refreshServices();
                addEventToLog('service', 'Service "' + (data.name||'') + '" state: ' + (data.state||''));
                break;
            case 'IndexingStarted':
                addEventToLog('indexing', 'Indexing started: ' + (data.collection||'unknown') + ' (' + (data.total_files||0) + ' files)');
                break;
            case 'IndexingProgress':
                var total = toIntegerSafe(data.total, 0);
                var processed = toIntegerSafe(data.processed, 0);
                var progress = total > 0 ? Math.round((processed / total) * 100) : 0;
                addEventToLog('indexing', 'Indexing progress: ' + progress + '% (' + processed + '/' + total + ')');
                break;
            case 'IndexingCompleted':
                addEventToLog('indexing', 'Indexing completed: ' + (data.collection||'unknown') + ' - ' + toIntegerSafe(data.chunks,0) + ' chunks indexed');
                break;
            case 'ConfigReloaded':
                addEventToLog('config', 'Configuration reloaded' + (data.changes ? ': ' + data.changes.join(', ') : ''));
                break;
            case 'HealthCheckCompleted':
                if (data.status) {
                    var statusEl = document.getElementById('status-value');
                    statusEl.textContent = data.status.toUpperCase();
                    statusEl.className = 'mt-2 text-3xl font-semibold status-' + data.status;
                }
                addEventToLog('health', 'Health check: ' + (data.status||'unknown'));
                break;
            case 'MetricsSnapshot':
                refreshMetrics();
                break;
            case 'SearchExecuted':
                addEventToLog('indexing', 'Search executed: "' + ((data.query||'').toString().substring(0,30)) + '..." - ' + toIntegerSafe(data.results,0) + ' results');
                break;
            case 'CacheInvalidate':
                addEventToLog('config', 'Cache invalidated: ' + (data.collection||'all'));
                break;
            case 'LogEvent':
                var lvl = (data.level||'info').toLowerCase();
                var tgt = data.target || '';
                var shortTarget = tgt.split('::').slice(-2).join('::');
                var ts = data.timestamp ? new Date(data.timestamp).toLocaleTimeString() : '';
                addLogEventToLog(lvl, (data.message||''), shortTarget, ts);
                break;
            case 'ValidationStarted':
                addEventToLog('validation', 'Validation started: ' + (data.scope||data.workspace||''));
                break;
            case 'ValidationProgress':
                var vTotal = toIntegerSafe(data.total, 0);
                var vDone = toIntegerSafe(data.completed, 0);
                var vPct = vTotal > 0 ? Math.round((vDone / vTotal) * 100) : 0;
                addEventToLog('validation', 'Validation progress: ' + vPct + '% (' + vDone + '/' + vTotal + ')');
                break;
            case 'ValidationCompleted':
                var violations = toIntegerSafe(data.violations, toIntegerSafe(data.violation_count, 0));
                addEventToLog('validation', 'Validation completed: ' + violations + ' violation' + (violations !== 1 ? 's' : '') + ' found');
                break;
            default:
                addEventToLog('system', 'Event: ' + eventType);
        }
    }

    async function refreshMetrics() {
        try {
            var resp = await adminFetch('/metrics');
            if (!resp.ok) { setMetricsZero(); return; }
            var m = await resp.json();
            var tq = toIntegerSafe(m.total_queries, 0);
            var sq = toIntegerSafe(m.successful_queries, 0);
            document.getElementById('metric-total-queries').textContent = String(tq);
            document.getElementById('metric-success-rate').textContent = (tq > 0 ? ((sq/tq)*100).toFixed(1) : '0.0') + '%';
            document.getElementById('metric-cache-hit').textContent = (toNumberSafe(m.cache_hit_rate,0)*100).toFixed(1) + '%';
            document.getElementById('metric-avg-response').textContent = toNumberSafe(m.average_response_time_ms,0).toFixed(1) + 'ms';
        } catch(e) { setMetricsZero(); }
    }

    function setMetricsZero() {
        document.getElementById('metric-total-queries').textContent = '0';
        document.getElementById('metric-success-rate').textContent = '0.0%';
        document.getElementById('metric-cache-hit').textContent = '0.0%';
        document.getElementById('metric-avg-response').textContent = '0.0ms';
    }

    function addEventToLog(type, message) {
        var log = document.getElementById('event-log');
        var empty = log.querySelector('.text-secondary');
        if (empty) empty.remove();
        var el = document.createElement('div');
        el.className = 'event-item event-' + type;
        el.innerHTML = '<span class="font-medium">' + new Date().toLocaleTimeString() + '</span><span class="ml-2">' + escapeHtml(message) + '</span>';
        log.insertBefore(el, log.firstChild);
        while (log.children.length > 50) log.removeChild(log.lastChild);
    }

    function addLogEventToLog(level, message, target, timestamp) {
        var log = document.getElementById('event-log');
        var empty = log.querySelector('.text-secondary');
        if (empty) empty.remove();
        var el = document.createElement('div');
        el.className = 'event-item event-log-' + level;
        var time = timestamp || new Date().toLocaleTimeString();
        el.innerHTML = '<span class="font-medium">' + escapeHtml(time) + '</span>' +
            '<span class="log-level log-level-' + level + ' ml-2">' + level.toUpperCase() + '</span>' +
            (target ? '<span class="ml-2" style="font-size:0.75rem;color:var(--text-muted)">' + escapeHtml(target) + '</span>' : '') +
            '<span class="ml-2">' + escapeHtml(message) + '</span>';
        log.insertBefore(el, log.firstChild);
        while (log.children.length > 100) log.removeChild(log.lastChild);
    }

    function clearEventLog() {
        document.getElementById('event-log').innerHTML = '<p class="text-secondary text-sm text-center py-4">Event log cleared</p>';
    }

    async function refreshServices() {
        try {
            var resp = await adminFetch('/services');
            var payload = await resp.json();
            renderServices(toArraySafe(payload && payload.services));
        } catch(e) {
            document.getElementById('services-list').innerHTML = '<p class="text-red-500 text-sm">Error loading services</p>';
        }
    }

    function renderServices(services) {
        var container = document.getElementById('services-list');
        if (!services || services.length === 0) {
            container.innerHTML = '<p class="text-secondary text-sm">No services registered</p>';
            return;
        }
        container.innerHTML = services.map(function(s) {
            var sl = String(s.state||'').toLowerCase();
            var sc = ['running','stopped','starting','stopping'].indexOf(sl) >= 0 ? sl : 'stopped';
            return '<div class="flex items-center justify-between p-3 rounded-lg" style="background:var(--bg-secondary)">' +
                '<div><span class="font-medium">' + escapeHtml(s.name) + '</span>' +
                '<span class="ml-2 text-sm status-' + sc + '">' + escapeHtml(String(s.state||'')) + '</span></div>' +
                '<div class="space-x-2">' +
                '<button class="btn btn-success btn-sm" onclick="controlService(\'' + escapeHtml(s.name) + '\',\'start\')"' + (s.state==='Running'?' disabled':'') + '>Start</button>' +
                '<button class="btn btn-warning btn-sm" onclick="controlService(\'' + escapeHtml(s.name) + '\',\'stop\')"' + (s.state==='Stopped'?' disabled':'') + '>Stop</button>' +
                '<button class="btn btn-primary btn-sm" onclick="controlService(\'' + escapeHtml(s.name) + '\',\'restart\')">Restart</button>' +
                '</div></div>';
        }).join('');
    }

    async function controlService(name, action) {
        try {
            var resp = await adminFetch('/services/' + encodeURIComponent(name) + '/' + action, { method: 'POST' });
            if (!resp.ok) { var err = await resp.json(); throw new Error(err.error || 'Operation failed'); }
            addEventToLog('service', action.charAt(0).toUpperCase() + action.slice(1) + ' requested for "' + name + '"');
            refreshServices();
        } catch(e) {
            addEventToLog('error', 'Failed to ' + action + ' service "' + name + '": ' + e.message);
        }
    }

    async function healthCheckAll() {
        try {
            var resp = await adminFetch('/services/health');
            var payload = await resp.json();
            toArraySafe(payload && payload.checks).forEach(function(c) {
                addEventToLog('health', c.name + ': ' + c.status + (c.message ? ' - ' + c.message : ''));
            });
        } catch(e) { addEventToLog('error', 'Health check failed: ' + e.message); }
    }

    async function loadInitialData() {
        try {
            var hr = await fetch('/health');
            var h = await hr.json();
            var st = (h.status||'unknown').toString().toLowerCase();
            document.getElementById('status-value').textContent = st.toUpperCase();
            document.getElementById('status-value').className = 'mt-2 text-3xl font-semibold status-' + st;
            document.getElementById('uptime-value').textContent = formatUptime(toIntegerSafe(h.uptime_seconds,0));
            document.getElementById('active-ops-value').textContent = String(toIntegerSafe(h.active_indexing_operations,0));
        } catch(e) {}
        await refreshMetrics();
        refreshServices();
    }

    document.addEventListener('DOMContentLoaded', function() { loadInitialData(); connectSSE(); });
    window.addEventListener('beforeunload', function() { if (eventSource) eventSource.close(); });
    document.body.addEventListener('htmx:afterRequest', function(evt) {
        if (evt.detail.successful) {
            var t = evt.detail.elt;
            if (t.textContent.indexOf('Reload Config') >= 0) addEventToLog('config', 'Configuration reload requested');
            else if (t.textContent.indexOf('Shutdown') >= 0) addEventToLog('system', 'Server shutdown requested');
        }
    });
</script>
{{/inline}}

{{> admin/layout}}
