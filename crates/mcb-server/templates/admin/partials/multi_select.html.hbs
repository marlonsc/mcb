{{!-- Multi-select tags partial â€” Alpine.js tag input for many-to-many relationships --}}
{{!-- Context: name, label, fk_target_slug, readonly, ../record (parent record for edit mode) --}}
<div x-data="{
    open: false,
    search: '',
    options: [],
    selected: [],
    loading: false,
    _timer: null,
    fetchOptions() {
        clearTimeout(this._timer);
        this.loading = true;
        this._timer = setTimeout(() => {
            fetch('/ui/lov/{{fk_target_slug}}?q=' + encodeURIComponent(this.search))
                .then(r => r.json())
                .then(data => {
                    this.options = data.filter(o => !this.selected.some(s => s.id === o.id));
                    this.loading = false;
                })
                .catch(() => {
                    this.options = [];
                    this.loading = false;
                });
        }, 300);
    },
    addItem(id, label) {
        if (!this.selected.some(s => s.id === id)) {
            this.selected.push({ id, label });
        }
        this.search = '';
        this.open = false;
    },
    removeItem(id) {
        this.selected = this.selected.filter(s => s.id !== id);
    },
    get hiddenValue() {
        return this.selected.map(s => s.id).join(',');
    },
    init() {
        let raw = '{{lookup ../record name}}';
        if (raw && raw !== '') {
            let ids = raw.split(',').map(s => s.trim()).filter(Boolean);
            if (ids.length > 0) {
                fetch('/ui/lov/{{fk_target_slug}}?q=')
                    .then(r => r.json())
                    .then(data => {
                        ids.forEach(id => {
                            let match = data.find(o => o.id === id);
                            if (match) {
                                this.selected.push({ id: match.id, label: match.label });
                            } else {
                                this.selected.push({ id, label: id });
                            }
                        });
                    })
                    .catch(() => {
                        ids.forEach(id => this.selected.push({ id, label: id }));
                    });
            }
        }
    }
}"
style="position: relative; margin-bottom: 1rem;"
@click.away="open = false"
@keydown.escape="open = false">

    <input type="hidden" name="{{name}}" :value="hiddenValue">

    {{!-- Selected tags --}}
    <div style="display: flex; flex-wrap: wrap; gap: 0.375rem; margin-bottom: 0.5rem; min-height: 1.5rem;">
        <template x-for="item in selected" :key="item.id">
            <span class="badge badge-blue"
                  style="display: inline-flex; align-items: center; gap: 0.25rem; padding: 0.25rem 0.5rem; font-size: 0.8125rem;">
                <span x-text="item.label"></span>
                {{#unless readonly}}
                <button type="button"
                        @click.stop="removeItem(item.id)"
                        style="background: none; border: none; cursor: pointer; padding: 0; margin-left: 0.125rem; font-size: 1rem; line-height: 1; color: inherit; opacity: 0.7;"
                        @mouseenter="$el.style.opacity='1'"
                        @mouseleave="$el.style.opacity='0.7'">&times;</button>
                {{/unless}}
            </span>
        </template>
    </div>

    {{!-- Search input --}}
    {{#unless readonly}}
    <input type="text"
           x-model="search"
           placeholder="Search to add..."
           style="margin-bottom: 0;"
           @focus="open = true; fetchOptions()"
           @input="open = true; fetchOptions()">

    {{!-- Dropdown --}}
    <div x-show="open"
         x-cloak
         style="position: absolute; z-index: 50; width: 100%; max-height: 12rem; overflow-y: auto; border: 1px solid var(--border-color, #e5e7eb); border-radius: 0.375rem; background: var(--bg-primary, #ffffff); box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-top: 0.125rem;">

        <template x-if="loading">
            <div style="padding: 0.5rem 0.75rem; color: var(--text-muted, #9ca3af); font-size: 0.875rem;">Loading...</div>
        </template>

        <template x-if="!loading && options.length === 0">
            <div style="padding: 0.5rem 0.75rem; color: var(--text-muted, #9ca3af); font-size: 0.875rem;">No results found</div>
        </template>

        <template x-if="!loading && options.length > 0">
            <div>
                <template x-for="opt in options" :key="opt.id">
                    <div @click="addItem(opt.id, opt.label)"
                         style="padding: 0.5rem 0.75rem; cursor: pointer; font-size: 0.875rem; color: var(--text-primary, #111827);"
                         @mouseenter="$el.style.background = 'var(--bg-secondary, #f9fafb)'"
                         @mouseleave="$el.style.background = 'transparent'">
                        <span x-text="opt.label"></span>
                    </div>
                </template>
            </div>
        </template>
    </div>
    {{/unless}}
</div>
