<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Memory Context Browser Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <script src="https://unpkg.com/htmx-ext-sse@2.2.2/sse.js"></script>
    <script src="https://unpkg.com/hyperscript.org@0.9.12"></script>
    <link rel="stylesheet" href="/ui/theme.css">
    <script src="/ui/shared.js"></script>
    <style>
        .status-healthy { color: #16a34a; }
        .status-degraded { color: #ca8a04; }
        .status-unhealthy { color: #dc2626; }
        .status-running { color: #16a34a; }
        .status-stopped { color: #6b7280; }
        .status-starting { color: #2563eb; }
        .status-stopping { color: #ca8a04; }
        .card { background: var(--card-bg, white); border-radius: 0.5rem; box-shadow: 0 1px 3px var(--card-shadow, rgba(0,0,0,0.1)); padding: 1.5rem; }
        .btn { padding: 0.5rem 1rem; border-radius: 0.375rem; font-weight: 500; transition: background-color 0.2s; cursor: pointer; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-primary { background: var(--accent, #2563eb); color: white; }
        .btn-primary:hover:not(:disabled) { background: var(--accent-hover, #1d4ed8); }
        .btn-success { background: #16a34a; color: white; }
        .btn-success:hover:not(:disabled) { background: #15803d; }
        .btn-warning { background: #ca8a04; color: white; }
        .btn-warning:hover:not(:disabled) { background: #a16207; }
        .btn-danger { background: #dc2626; color: white; }
        .btn-danger:hover:not(:disabled) { background: #b91c1c; }
        .btn-sm { padding: 0.25rem 0.5rem; font-size: 0.875rem; }
        .sse-indicator { display: inline-block; width: 8px; height: 8px; border-radius: 50%; margin-right: 0.5rem; }
        .sse-connected { background: #16a34a; animation: pulse 2s infinite; }
        .sse-disconnected { background: #dc2626; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .event-log { max-height: 300px; overflow-y: auto; }
        .event-item { border-left: 3px solid; padding: 0.5rem 1rem; margin-bottom: 0.5rem; font-size: 0.875rem; }
        .event-indexing { border-color: #2563eb; background: #eff6ff; }
        .event-service { border-color: #16a34a; background: #f0fdf4; }
        .event-config { border-color: #ca8a04; background: #fefce8; }
        .event-health { border-color: #8b5cf6; background: #f5f3ff; }
        .event-error { border-color: #dc2626; background: #fef2f2; }
    </style>
</head>
<body class="bg-primary text-primary min-h-screen">
    <div id="app-shell">
        <div class="mb-8 flex items-center justify-between">
            <div>
                <h1 class="text-3xl font-bold">Dashboard</h1>
                <p class="mt-2 text-secondary">System overview and real-time metrics via SSE</p>
            </div>
            <span id="sse-status" class="flex items-center text-sm">
                <span class="sse-indicator sse-disconnected" id="sse-indicator"></span>
                <span id="sse-text">Disconnected</span>
            </span>
        </div>

        <!-- Health Status Cards -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div class="card" id="health-card">
                <h3 class="text-sm font-medium text-secondary uppercase tracking-wider">Status</h3>
                <p class="mt-2 text-3xl font-semibold text-muted" id="status-value">Loading...</p>
            </div>

            <div class="card" id="uptime-card">
                <h3 class="text-sm font-medium text-secondary uppercase tracking-wider">Uptime</h3>
                <p class="mt-2 text-3xl font-semibold" id="uptime-value">Loading...</p>
            </div>

            <div class="card" id="active-ops-card">
                <h3 class="text-sm font-medium text-secondary uppercase tracking-wider">Active Operations</h3>
                <p class="mt-2 text-3xl font-semibold" id="active-ops-value">Loading...</p>
            </div>
        </div>

        <!-- Metrics Section -->
        <div class="card mb-8" id="metrics-section">
            <h2 class="text-lg font-semibold mb-4">Performance Metrics</h2>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-6">
                <div>
                    <p class="text-sm text-secondary">Total Queries</p>
                    <p class="text-2xl font-semibold" id="metric-total-queries">Loading...</p>
                </div>
                <div>
                    <p class="text-sm text-secondary">Success Rate</p>
                    <p class="text-2xl font-semibold" id="metric-success-rate">Loading...</p>
                </div>
                <div>
                    <p class="text-sm text-secondary">Cache Hit Rate</p>
                    <p class="text-2xl font-semibold" id="metric-cache-hit">Loading...</p>
                </div>
                <div>
                    <p class="text-sm text-secondary">Avg Response Time</p>
                    <p class="text-2xl font-semibold" id="metric-avg-response">Loading...</p>
                </div>
            </div>
        </div>

        <!-- Services Section -->
        <div class="card mb-8">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-lg font-semibold">Services</h2>
                <button class="btn btn-primary btn-sm" onclick="refreshServices()">Refresh</button>
            </div>
            <div id="services-list" class="space-y-3">
                <p class="text-secondary text-sm">Loading services...</p>
            </div>
        </div>

        <!-- Event Log Section -->
        <div class="card mb-8">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-lg font-semibold">Live Event Log</h2>
                <button class="btn btn-sm btn-secondary" onclick="clearEventLog()">Clear</button>
            </div>
            <div id="event-log" class="event-log">
                <p class="text-secondary text-sm text-center py-4">Waiting for events...</p>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="card">
            <h2 class="text-lg font-semibold mb-4">Quick Actions</h2>
            <div class="flex flex-wrap gap-4">
                <button class="btn btn-primary"
                        hx-post="/config/reload"
                        hx-swap="none"
                        hx-confirm="Reload configuration from file?">
                    Reload Config
                </button>
                <button class="btn btn-warning" onclick="healthCheckAll()">
                    Health Check All
                </button>
                <button class="btn btn-danger"
                        hx-post="/shutdown"
                        hx-vals='{"timeout_secs": 30}'
                        hx-confirm="Are you sure you want to shutdown the server?"
                        hx-swap="none">
                    Shutdown Server
                </button>
            </div>
        </div>
    </div>

    <script>
        // =========================================================================
        // SSE Connection Management
        // =========================================================================
        let eventSource = null;
        let reconnectAttempts = 0;
        const maxReconnectAttempts = 5;
        const reconnectDelay = 3000;

        function connectSSE() {
            if (eventSource) {
                eventSource.close();
            }

            eventSource = new EventSource('/events');

            eventSource.onopen = function() {
                console.log('SSE connected');
                reconnectAttempts = 0;
                updateSSEStatus(true);
                addEventToLog('system', 'Connected to event stream');
            };

            eventSource.onerror = function(e) {
                console.error('SSE error:', e);
                updateSSEStatus(false);

                if (reconnectAttempts < maxReconnectAttempts) {
                    reconnectAttempts++;
                    addEventToLog('error', `Connection lost. Reconnecting (${reconnectAttempts}/${maxReconnectAttempts})...`);
                    setTimeout(connectSSE, reconnectDelay);
                } else {
                    addEventToLog('error', 'Max reconnect attempts reached. Please refresh the page.');
                }
            };

            // Register event handlers for each event type
            const eventTypes = [
                'IndexRebuild', 'IndexingStarted', 'IndexingProgress', 'IndexingCompleted',
                'SyncCompleted', 'CacheInvalidate', 'SnapshotCreated', 'FileChangesDetected',
                'ServiceStateChanged', 'ConfigReloaded', 'HealthCheckCompleted',
                'MetricsSnapshot', 'SearchExecuted'
            ];

            eventTypes.forEach(eventType => {
                eventSource.addEventListener(eventType, function(e) {
                    handleEvent(eventType, parseJsonSafe(e.data, {}));
                });
            });
        }

        function updateSSEStatus(connected) {
            const indicator = document.getElementById('sse-indicator');
            const text = document.getElementById('sse-text');

            if (connected) {
                indicator.classList.remove('sse-disconnected');
                indicator.classList.add('sse-connected');
                text.textContent = 'Live';
            } else {
                indicator.classList.remove('sse-connected');
                indicator.classList.add('sse-disconnected');
                text.textContent = 'Disconnected';
            }
        }

        // =========================================================================
        // Event Handlers
        // =========================================================================
        function handleEvent(eventType, data) {
            console.log('Received event:', eventType, data);

            switch (eventType) {
                case 'ServiceStateChanged':
                    handleServiceStateChanged(data);
                    addEventToLog('service', `Service "${data.name}" state: ${data.state}`);
                    break;

                case 'IndexingStarted':
                    addEventToLog('indexing', `Indexing started: ${data.collection || 'unknown'} (${data.total_files || 0} files)`);
                    break;

                case 'IndexingProgress':
                    {
                        const total = toIntegerSafe(data.total, 0);
                        const processed = toIntegerSafe(data.processed, 0);
                        const progress = total > 0
                            ? Math.round((processed / total) * 100)
                            : 0;
                        addEventToLog('indexing', `Indexing progress: ${progress}% (${processed}/${total})`);
                    }
                    break;

                case 'IndexingCompleted':
                    addEventToLog('indexing', `Indexing completed: ${data.collection || 'unknown'} - ${toIntegerSafe(data.chunks, 0)} chunks indexed`);
                    break;

                case 'ConfigReloaded':
                    addEventToLog('config', `Configuration reloaded${data.changes ? ': ' + data.changes.join(', ') : ''}`);
                    break;

                case 'HealthCheckCompleted':
                    handleHealthCheckCompleted(data);
                    addEventToLog('health', `Health check: ${data.status || 'unknown'}`);
                    break;

                case 'MetricsSnapshot':
                    refreshMetrics();
                    break;

                case 'SearchExecuted':
                    addEventToLog('indexing', `Search executed: "${(data.query || '').toString().substring(0, 30)}..." - ${toIntegerSafe(data.results, 0)} results`);
                    break;

                case 'CacheInvalidate':
                    addEventToLog('config', `Cache invalidated: ${data.collection || 'all'}`);
                    break;

                default:
                    addEventToLog('system', `Event: ${eventType}`);
            }
        }

        function handleServiceStateChanged(data) {
            refreshServices();
        }

        function handleHealthCheckCompleted(data) {
            if (data.status) {
                const statusEl = document.getElementById('status-value');
                statusEl.textContent = data.status.toUpperCase();
                statusEl.className = 'mt-2 text-3xl font-semibold status-' + data.status;
            }
        }

        function handleMetricsSnapshot(data) {
            if (data.total_queries !== undefined) {
                document.getElementById('metric-total-queries').textContent = data.total_queries;
            }
            if (data.successful_queries !== undefined && data.total_queries > 0) {
                const rate = ((data.successful_queries / data.total_queries) * 100).toFixed(1);
                document.getElementById('metric-success-rate').textContent = rate + '%';
            }
            if (data.cache_hit_rate !== undefined) {
                document.getElementById('metric-cache-hit').textContent = (data.cache_hit_rate * 100).toFixed(1) + '%';
            }
            if (data.average_response_time_ms !== undefined) {
                document.getElementById('metric-avg-response').textContent = data.average_response_time_ms.toFixed(1) + 'ms';
            }
            if (data.uptime_seconds !== undefined) {
                document.getElementById('uptime-value').textContent = formatUptime(data.uptime_seconds);
            }
        }

        async function refreshMetrics() {
            try {
                const metricsResponse = await adminFetch('/metrics');
                if (!metricsResponse.ok) {
                    document.getElementById('metric-total-queries').textContent = '0';
                    document.getElementById('metric-success-rate').textContent = '0.0%';
                    document.getElementById('metric-cache-hit').textContent = '0.0%';
                    document.getElementById('metric-avg-response').textContent = '0.0ms';
                    return;
                }
                const metrics = await metricsResponse.json();
                const totalQueries = toIntegerSafe(metrics.total_queries, 0);
                const successfulQueries = toIntegerSafe(metrics.successful_queries, 0);
                const cacheHitRate = toNumberSafe(metrics.cache_hit_rate, 0);
                const avgResponseMs = toNumberSafe(metrics.average_response_time_ms, 0);

                document.getElementById('metric-total-queries').textContent = String(totalQueries);
                const successRate = totalQueries > 0
                    ? ((successfulQueries / totalQueries) * 100).toFixed(1)
                    : '0.0';
                document.getElementById('metric-success-rate').textContent = successRate + '%';
                document.getElementById('metric-cache-hit').textContent = (cacheHitRate * 100).toFixed(1) + '%';
                document.getElementById('metric-avg-response').textContent = avgResponseMs.toFixed(1) + 'ms';
            } catch (e) {
                document.getElementById('metric-total-queries').textContent = '0';
                document.getElementById('metric-success-rate').textContent = '0.0%';
                document.getElementById('metric-cache-hit').textContent = '0.0%';
                document.getElementById('metric-avg-response').textContent = '0.0ms';
            }
        }

        // =========================================================================
        // Event Log Management
        // =========================================================================
        function addEventToLog(type, message) {
            const log = document.getElementById('event-log');
             const emptyMessage = log.querySelector('.text-secondary');
            if (emptyMessage) {
                emptyMessage.remove();
            }

            const eventEl = document.createElement('div');
            eventEl.className = 'event-item event-' + type;
            eventEl.innerHTML = `
                <span class="font-medium">${new Date().toLocaleTimeString()}</span>
                <span class="ml-2">${escapeHtml(message)}</span>
            `;

            log.insertBefore(eventEl, log.firstChild);

            // Keep only last 50 events
            while (log.children.length > 50) {
                log.removeChild(log.lastChild);
            }
        }

        function clearEventLog() {
            const log = document.getElementById('event-log');
             log.innerHTML = '<p class="text-secondary text-sm text-center py-4">Event log cleared</p>';
        }

        // =========================================================================
        // Services Management
        // =========================================================================
        async function refreshServices() {
            try {
                const response = await adminFetch('/services');
                const payload = await response.json();
                const services = toArraySafe(payload && payload.services);
                renderServices(services);
            } catch (e) {
                console.error('Error fetching services:', e);
                document.getElementById('services-list').innerHTML =
                    '<p class="text-red-500 text-sm">Error loading services</p>';
            }
        }

        function renderServices(services) {
            const container = document.getElementById('services-list');

            if (!services || services.length === 0) {
                 container.innerHTML = '<p class="text-secondary text-sm">No services registered</p>';
                return;
            }

            container.innerHTML = services.map(service => {
                const stateLower = String(service.state || '').toLowerCase();
                const safeStateClass = ['running', 'stopped', 'starting', 'stopping'].includes(stateLower) ? stateLower : 'stopped';
                return `
                 <div class="flex items-center justify-between p-3 rounded-lg" style="background: var(--bg-secondary)">
                    <div>
                        <span class="font-medium">${escapeHtml(service.name)}</span>
                        <span class="ml-2 text-sm status-${safeStateClass}">${escapeHtml(String(service.state || ''))}</span>
                    </div>
                    <div class="space-x-2">
                        <button class="btn btn-success btn-sm"
                                onclick="controlService('${escapeHtml(service.name)}', 'start')"
                                ${service.state === 'Running' ? 'disabled' : ''}>
                            Start
                        </button>
                        <button class="btn btn-warning btn-sm"
                                onclick="controlService('${escapeHtml(service.name)}', 'stop')"
                                ${service.state === 'Stopped' ? 'disabled' : ''}>
                            Stop
                        </button>
                        <button class="btn btn-primary btn-sm"
                                onclick="controlService('${escapeHtml(service.name)}', 'restart')">
                            Restart
                        </button>
                    </div>
                </div>
            `;
            }).join('');
        }

        async function controlService(name, action) {
            try {
                const response = await adminFetch(`/services/${encodeURIComponent(name)}/${action}`, {
                    method: 'POST'
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Operation failed');
                }

                addEventToLog('service', `${action.charAt(0).toUpperCase() + action.slice(1)} requested for "${name}"`);
                refreshServices();
            } catch (e) {
                console.error('Service control error:', e);
                addEventToLog('error', `Failed to ${action} service "${name}": ${e.message}`);
            }
        }

        async function healthCheckAll() {
            try {
                const response = await adminFetch('/services/health');
                const payload = await response.json();
                const checks = toArraySafe(payload && payload.checks);

                checks.forEach(check => {
                    addEventToLog('health', `${check.name}: ${check.status} ${check.message ? '- ' + check.message : ''}`);
                });
            } catch (e) {
                console.error('Health check error:', e);
                addEventToLog('error', 'Health check failed: ' + e.message);
            }
        }

        // =========================================================================
        // Initial Data Loading
        // =========================================================================
        async function loadInitialData() {
            // Load health
            try {
                const healthResponse = await fetch('/health');
                const health = await healthResponse.json();
                const status = (health.status || 'unknown').toString().toLowerCase();
                document.getElementById('status-value').textContent = status.toUpperCase();
                document.getElementById('status-value').className = 'mt-2 text-3xl font-semibold status-' + status;
                document.getElementById('uptime-value').textContent = formatUptime(toIntegerSafe(health.uptime_seconds, 0));
                document.getElementById('active-ops-value').textContent = String(toIntegerSafe(health.active_indexing_operations, 0));
            } catch (e) {
                console.error('Error loading health:', e);
            }

            // Load metrics
            await refreshMetrics();

            // Load services
            refreshServices();
        }

        // =========================================================================
        // Initialize
        // =========================================================================
        document.addEventListener('DOMContentLoaded', function() {
            loadInitialData();
            connectSSE();
        });

        // Cleanup on page unload
        window.addEventListener('beforeunload', function() {
            if (eventSource) {
                eventSource.close();
            }
        });

        // HTMX event handlers
        document.body.addEventListener('htmx:afterRequest', function(evt) {
            if (evt.detail.successful) {
                const target = evt.detail.elt;
                if (target.textContent.includes('Reload Config')) {
                    addEventToLog('config', 'Configuration reload requested');
                } else if (target.textContent.includes('Shutdown')) {
                    addEventToLog('system', 'Server shutdown requested');
                }
            }
        });
    </script>
</body>
</html>
