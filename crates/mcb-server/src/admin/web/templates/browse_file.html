<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>View Code - MCP Context Browser Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.3/dist/cdn.min.js"></script>
    <link rel="stylesheet" href="/ui/theme.css">
    <script src="/ui/shared.js"></script>
    <style>
        .card { background: var(--card-bg); border-radius: 0.5rem; box-shadow: 0 1px 3px var(--card-shadow); }
        .chunk-header { background: var(--nav-bg); color: var(--nav-text); padding: 0.75rem 1rem; font-size: 0.875rem; }
        .chunk-header .chunk-lines { color: var(--text-muted); opacity: 0.7; }
        .chunk-code { margin: 0 !important; border-radius: 0 0 0.5rem 0.5rem !important; }
        pre[class*="language-"] { margin: 0 !important; background: var(--bg-code) !important; }
        code[class*="language-"] { font-size: 0.875rem; line-height: 1.5; }
        .line-numbers .line-numbers-rows { border-right-color: var(--border-color); }
        .btn { padding: 0.5rem 1rem; border-radius: 0.375rem; font-weight: 500; transition: background-color 0.2s; cursor: pointer; text-decoration: none; display: inline-block; }
        .btn-secondary { background: var(--bg-tertiary); color: var(--text-primary); }
        .btn-secondary:hover { background: var(--bg-secondary); }
        .chunk-id { font-family: monospace; font-size: 0.75rem; color: var(--text-muted); }
    </style>
</head>
<body class="min-h-screen bg-primary text-primary">
    <div id="app-shell">
        <!-- Breadcrumb -->
        <nav class="mb-4 text-sm">
            <ol class="flex items-center space-x-2 flex-wrap">
                <li><a href="/ui/browse" class="text-blue-600 hover:underline">Collections</a></li>
                <li><span class="text-secondary">/</span></li>
                <li><a href="#" id="collection-link" class="text-blue-600 hover:underline">Loading...</a></li>
                <li><span class="text-secondary">/</span></li>
                <li class="text-primary font-medium truncate max-w-md" id="file-path">Loading...</li>
            </ol>
        </nav>

        <div class="mb-8 flex items-start justify-between">
            <div>
                <h1 class="text-2xl font-bold text-primary break-all" id="page-title">File Chunks</h1>
                <p class="mt-2 text-secondary" id="chunk-count">Loading chunks...</p>
            </div>
            <a href="#" id="back-link" class="btn btn-secondary">
                Back to Files
            </a>
        </div>

        <!-- Chunks List -->
        <div id="chunks-container" class="space-y-6">
            <div class="card p-8 text-center">
                <p class="text-secondary">Loading code chunks...</p>
            </div>
        </div>
    </div>

    <script>
        // Parse URL params
        const urlParams = new URLSearchParams(window.location.search);
        const filePath = urlParams.get('path') || '';

        // Get collection from URL path
        const pathParts = window.location.pathname.split('/');
        // URL format: /ui/browse/:collection/file
        const collectionIndex = pathParts.indexOf('browse') + 1;
        const collectionName = decodeURIComponent(pathParts[collectionIndex] || '');

        // Update breadcrumb
        document.getElementById('collection-link').textContent = collectionName;
        document.getElementById('collection-link').href = `/ui/browse/${encodeURIComponent(collectionName)}`;
        document.getElementById('file-path').textContent = filePath;
        document.getElementById('page-title').textContent = filePath.split('/').pop() || 'File';
        document.getElementById('back-link').href = `/ui/browse/${encodeURIComponent(collectionName)}`;

        async function loadChunks() {
            const container = document.getElementById('chunks-container');

            try {
                const response = await adminFetch(`/collections/${encodeURIComponent(collectionName)}/chunks/${encodeURIComponent(filePath)}`);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                const data = await response.json();
                const chunks = toArraySafe(data && data.chunks);
                const total = toIntegerSafe(data && data.total, chunks.length);
                document.getElementById('chunk-count').textContent = `${total} chunks indexed from this file`;
                renderChunks(chunks, data && data.language);
            } catch (e) {
                console.error('Error loading chunks:', e);
                document.getElementById('chunk-count').textContent = 'â€”';
                container.innerHTML = `
                    <div class="card p-8 text-center">
                        <p class="text-red-500 font-medium">Error loading chunks</p>
                        <p class="text-secondary text-sm mt-2">${escapeHtml(e.message)}</p>
                    </div>
                `;
            }
        }

        function renderChunks(chunks, _defaultLang) {
            const container = document.getElementById('chunks-container');

            if (!chunks || chunks.length === 0) {
                container.innerHTML = `
                    <div class="card p-8 text-center">
                        <p class="text-secondary">No chunks found for this file</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = chunks.map((chunk, idx) => {
                return `
                    <div class="card overflow-hidden" id="chunk-${idx}">
                        <div class="chunk-header flex items-center justify-between">
                            <div class="flex items-center space-x-4">
                                <span class="chunk-lines">Lines ${toIntegerSafe(chunk.start_line, 0)} - ${toIntegerSafe(chunk.end_line, 0)}</span>
                                <span class="chunk-id">${escapeHtml(String(chunk.id || '').substring(0, 12))}...</span>
                            </div>
                            <button onclick="copyChunk(${idx})" class="text-sm text-secondary hover:text-white transition-colors">
                                Copy
                            </button>
                        </div>
                        <pre id="code-${idx}" class="chunk-code" style="background: var(--bg-code); color: var(--text-primary);">${chunk.highlighted_html || ''}</pre>
                    </div>
                `;
            }).join('');
        }

        function copyChunk(idx) {
            const code = document.getElementById(`code-${idx}`);
            navigator.clipboard.writeText(code.textContent).then(() => {
                // Show brief feedback (requires event to be available)
                if (window.event && window.event.target) {
                    const btn = window.event.target.closest('button');
                    if (btn) {
                        const original = btn.textContent;
                        btn.textContent = 'Copied!';
                        setTimeout(() => {
                            btn.textContent = original;
                        }, 1500);
                    }
                }
            }).catch(err => {
                 console.error('Failed to copy:', err);
            });
        }

        // Keyboard navigation for chunks
        let selectedChunk = -1;
        
        function selectChunk(index) {
            const chunks = document.querySelectorAll('#chunks-container .card');
            if (chunks.length === 0) return;
            
            index = Math.max(0, Math.min(index, chunks.length - 1));
            
            if (selectedChunk >= 0 && chunks[selectedChunk]) {
                chunks[selectedChunk].classList.remove('ring-2', 'ring-blue-500');
            }
            
            selectedChunk = index;
            chunks[selectedChunk].classList.add('ring-2', 'ring-blue-500');
            chunks[selectedChunk].scrollIntoView({ block: 'center' });
        }
        
        document.addEventListener('keydown', (e) => {
            const chunks = document.querySelectorAll('#chunks-container .card');
            if (chunks.length === 0) return;
            
            switch (e.key) {
                case 'j':
                case 'ArrowDown':
                    selectChunk(selectedChunk + 1);
                    e.preventDefault();
                    break;
                case 'k':
                case 'ArrowUp':
                    selectChunk(selectedChunk - 1);
                    e.preventDefault();
                    break;
                case 'g':
                    if (e.shiftKey) {
                        selectChunk(chunks.length - 1);
                    } else {
                        selectChunk(0);
                    }
                    e.preventDefault();
                    break;
                case 'c':
                    if (selectedChunk >= 0) copyChunk(selectedChunk);
                    break;
                case 'Escape':
                    {
                        // Go back to file list if we can navigate
                        const backLink = document.getElementById('back-link');
                        if (backLink) window.location.href = backLink.href;
                    }
                    break;
            }
        });

        // Load on page ready
        document.addEventListener('DOMContentLoaded', loadChunks);
    </script>
</body>
</html>
