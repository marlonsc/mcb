<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>View Code - MCP Context Browser Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.3/dist/cdn.min.js"></script>
    <link rel="stylesheet" href="/ui/theme.css">
    <!-- Prism Core only - theme handled by theme.css -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/line-numbers/prism-line-numbers.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/line-numbers/prism-line-numbers.min.css">
    <!-- Language support -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-rust.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-typescript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-go.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-java.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-c.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-cpp.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-csharp.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-ruby.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-php.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-swift.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-kotlin.min.js"></script>
    <script src="/ui/shared.js"></script>
    <script>
        // Theme initialization (runs before Alpine)
        (function() {
            const saved = localStorage.getItem('mcb-theme');
            if (saved) document.documentElement.setAttribute('data-theme', saved);
        })();
    </script>
    <style>
        .card { background: var(--card-bg); border-radius: 0.5rem; box-shadow: 0 1px 3px var(--card-shadow); }
        .chunk-header { background: var(--nav-bg); color: var(--nav-text); padding: 0.75rem 1rem; font-size: 0.875rem; }
        .chunk-header .chunk-lines { color: var(--text-muted); opacity: 0.7; }
        .chunk-code { margin: 0 !important; border-radius: 0 0 0.5rem 0.5rem !important; }
        pre[class*="language-"] { margin: 0 !important; background: var(--bg-code) !important; }
        code[class*="language-"] { font-size: 0.875rem; line-height: 1.5; }
        .line-numbers .line-numbers-rows { border-right-color: var(--border-color); }
        .btn { padding: 0.5rem 1rem; border-radius: 0.375rem; font-weight: 500; transition: background-color 0.2s; cursor: pointer; text-decoration: none; display: inline-block; }
        .btn-secondary { background: var(--bg-tertiary); color: var(--text-primary); }
        .btn-secondary:hover { background: var(--bg-secondary); }
        .chunk-id { font-family: monospace; font-size: 0.75rem; color: var(--text-muted); }
    </style>
</head>
<body class="min-h-screen bg-primary text-primary">
    <nav class="nav-theme">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <div class="flex items-center">
                    <span class="text-xl font-bold">MCP Context Browser</span>
                    <span class="ml-2 text-sm text-gray-400">Admin</span>
                </div>
                <div class="flex items-center space-x-4">
                    <a href="/" class="px-3 py-2 rounded-md text-sm font-medium hover:bg-gray-700 text-white">Dashboard</a>
                    <a href="/ui/config" class="px-3 py-2 rounded-md text-sm font-medium hover:bg-gray-700 text-white">Config</a>
                    <a href="/ui/health" class="px-3 py-2 rounded-md text-sm font-medium hover:bg-gray-700 text-white">Health</a>
                    <a href="/ui/indexing" class="px-3 py-2 rounded-md text-sm font-medium hover:bg-gray-700 text-white">Indexing</a>
                    <a href="/ui/browse" class="px-3 py-2 rounded-md text-sm font-medium bg-gray-900 text-white">Browse</a>
                    
                    <!-- Theme Toggle -->
                    <button x-data="{ 
                        theme: localStorage.getItem('mcb-theme') || 'auto',
                        toggle() {
                            const next = { auto: 'light', light: 'dark', dark: 'auto' };
                            this.theme = next[this.theme];
                            if (this.theme === 'auto') {
                                localStorage.removeItem('mcb-theme');
                                document.documentElement.removeAttribute('data-theme');
                            } else {
                                localStorage.setItem('mcb-theme', this.theme);
                                document.documentElement.setAttribute('data-theme', this.theme);
                            }
                        }
                    }" @click="toggle()" class="px-3 py-2 rounded-md text-sm font-medium hover:bg-gray-700 text-white" title="Toggle Theme">
                        <span x-show="theme === 'auto'">Auto</span>
                        <span x-show="theme === 'light'">Light</span>  
                        <span x-show="theme === 'dark'">Dark</span>
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Breadcrumb -->
        <nav class="mb-4 text-sm">
            <ol class="flex items-center space-x-2 flex-wrap">
                <li><a href="/ui/browse" class="text-blue-600 hover:underline">Collections</a></li>
                <li><span class="text-secondary">/</span></li>
                <li><a href="#" id="collection-link" class="text-blue-600 hover:underline">Loading...</a></li>
                <li><span class="text-secondary">/</span></li>
                <li class="text-primary font-medium truncate max-w-md" id="file-path">Loading...</li>
            </ol>
        </nav>

        <div class="mb-8 flex items-start justify-between">
            <div>
                <h1 class="text-2xl font-bold text-primary break-all" id="page-title">File Chunks</h1>
                <p class="mt-2 text-secondary" id="chunk-count">Loading chunks...</p>
            </div>
            <a href="#" id="back-link" class="btn btn-secondary">
                Back to Files
            </a>
        </div>

        <!-- Chunks List -->
        <div id="chunks-container" class="space-y-6">
            <div class="card p-8 text-center">
                <p class="text-secondary">Loading code chunks...</p>
            </div>
        </div>
    </main>

    <footer class="nav-theme py-4 mt-8">
        <div class="max-w-7xl mx-auto px-4 text-center text-sm">
            MCP Context Browser v0.1.5 | Browse Indexed Code
        </div>
    </footer>

    <script>
        // Parse URL params
        const urlParams = new URLSearchParams(window.location.search);
        const filePath = urlParams.get('path') || '';

        // Get collection from URL path
        const pathParts = window.location.pathname.split('/');
        // URL format: /ui/browse/:collection/file
        const collectionIndex = pathParts.indexOf('browse') + 1;
        const collectionName = decodeURIComponent(pathParts[collectionIndex] || '');

        // Update breadcrumb
        document.getElementById('collection-link').textContent = collectionName;
        document.getElementById('collection-link').href = `/ui/browse/${encodeURIComponent(collectionName)}`;
        document.getElementById('file-path').textContent = filePath;
        document.getElementById('page-title').textContent = filePath.split('/').pop() || 'File';
        document.getElementById('back-link').href = `/ui/browse/${encodeURIComponent(collectionName)}`;

        async function loadChunks() {
            const container = document.getElementById('chunks-container');

            try {
                const response = await adminFetch(`/collections/${encodeURIComponent(collectionName)}/chunks/${encodeURIComponent(filePath)}`);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                const data = await response.json();
                document.getElementById('chunk-count').textContent = `${data.total} chunks indexed from this file`;
                renderChunks(data.chunks, data.language);
            } catch (e) {
                console.error('Error loading chunks:', e);
                document.getElementById('chunk-count').textContent = 'â€”';
                container.innerHTML = `
                    <div class="card p-8 text-center">
                        <p class="text-red-500 font-medium">Error loading chunks</p>
                        <p class="text-secondary text-sm mt-2">${escapeHtml(e.message)}</p>
                    </div>
                `;
            }
        }

        function renderChunks(chunks, defaultLang) {
            const container = document.getElementById('chunks-container');

            if (!chunks || chunks.length === 0) {
                container.innerHTML = `
                    <div class="card p-8 text-center">
                        <p class="text-secondary">No chunks found for this file</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = chunks.map((chunk, idx) => {
                const lang = (chunk.language || defaultLang || 'text').toLowerCase();
                const prismLang = getPrismLanguage(lang);

                return `
                    <div class="card overflow-hidden" id="chunk-${idx}">
                        <div class="chunk-header flex items-center justify-between">
                            <div class="flex items-center space-x-4">
                                <span class="chunk-lines">Lines ${chunk.start_line} - ${chunk.end_line}</span>
                                <span class="chunk-id">${escapeHtml(chunk.id.substring(0, 12))}...</span>
                            </div>
                            <button onclick="copyChunk(${idx})" class="text-sm text-gray-400 hover:text-white transition-colors">
                                Copy
                            </button>
                        </div>
                        <pre class="chunk-code line-numbers" data-start="${chunk.start_line}"><code class="language-${prismLang}" id="code-${idx}">${escapeHtml(chunk.content)}</code></pre>
                    </div>
                `;
            }).join('');

            // Re-run Prism highlighting
            Prism.highlightAll();
        }

        function getPrismLanguage(lang) {
            const map = {
                'rust': 'rust',
                'python': 'python',
                'javascript': 'javascript',
                'typescript': 'typescript',
                'go': 'go',
                'java': 'java',
                'c': 'c',
                'cpp': 'cpp',
                'c++': 'cpp',
                'csharp': 'csharp',
                'c#': 'csharp',
                'ruby': 'ruby',
                'php': 'php',
                'swift': 'swift',
                'kotlin': 'kotlin'
            };
            return map[lang] || 'clike';
        }

        function copyChunk(idx) {
            const code = document.getElementById(`code-${idx}`);
            navigator.clipboard.writeText(code.textContent).then(() => {
                // Show brief feedback (requires event to be available)
                if (window.event && window.event.target) {
                    const btn = window.event.target.closest('button');
                    if (btn) {
                        const original = btn.textContent;
                        btn.textContent = 'Copied!';
                        setTimeout(() => btn.textContent = original, 1500);
                    }
                }
            }).catch(err => {
                 console.error('Failed to copy:', err);
            });
        }

        // Keyboard navigation for chunks
        let selectedChunk = -1;
        
        function selectChunk(index) {
            const chunks = document.querySelectorAll('#chunks-container .card');
            if (chunks.length === 0) return;
            
            index = Math.max(0, Math.min(index, chunks.length - 1));
            
            if (selectedChunk >= 0 && chunks[selectedChunk]) {
                chunks[selectedChunk].classList.remove('ring-2', 'ring-blue-500');
            }
            
            selectedChunk = index;
            chunks[selectedChunk].classList.add('ring-2', 'ring-blue-500');
            chunks[selectedChunk].scrollIntoView({ block: 'center' });
        }
        
        document.addEventListener('keydown', (e) => {
            const chunks = document.querySelectorAll('#chunks-container .card');
            if (chunks.length === 0) return;
            
            switch (e.key) {
                case 'j':
                case 'ArrowDown':
                    selectChunk(selectedChunk + 1);
                    e.preventDefault();
                    break;
                case 'k':
                case 'ArrowUp':
                    selectChunk(selectedChunk - 1);
                    e.preventDefault();
                    break;
                case 'g':
                    if (e.shiftKey) {
                        selectChunk(chunks.length - 1);
                    } else {
                        selectChunk(0);
                    }
                    e.preventDefault();
                    break;
                case 'c':
                    if (selectedChunk >= 0) copyChunk(selectedChunk);
                    break;
                case 'Escape':
                    // Go back to file list if we can navigate
                    const backLink = document.getElementById('back-link');
                    if (backLink) window.location.href = backLink.href;
                    break;
            }
        });

        // Load on page ready
        document.addEventListener('DOMContentLoaded', loadChunks);
    </script>
</body>
</html>
