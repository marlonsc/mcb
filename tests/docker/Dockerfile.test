FROM rust:slim

RUN apt-get update && apt-get install -y --no-install-recommends \
    curl \
    git \
    make \
    netcat-traditional \
    nodejs \
    npm \
    lsof \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /app
COPY . .

# Pre-fetch Rust deps, install Playwright, create user
RUN cargo fetch && \
    npm --prefix tests install --save-dev @playwright/test @types/node typescript 2>&1 | grep -v "^npm WARN" || true && \
    (cd tests && npx playwright install chromium --with-deps 2>&1 | tail -3) || true && \
    useradd -m appuser && chown -R appuser:appuser /app

USER appuser

HEALTHCHECK --interval=30s --timeout=3s CMD ["cargo", "--version"]

CMD ["make", "test-rust"]
