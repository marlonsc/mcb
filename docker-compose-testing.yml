version: '3.8'

services:
  # Ollama - Local embedding model
  ollama:
    image: ollama/ollama:latest
    container_name: mcb-ollama
    ports:
      - "11434:11434"
    volumes:
      - ollama_data:/root/.ollama
    environment:
      - OLLAMA_KEEP_ALIVE=24h
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:11434/api/tags"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    networks:
      - mcb-network
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 4G
        reservations:
          cpus: '1'
          memory: 2G

  # Milvus - Vector database
  milvus:
    image: milvusdb/milvus:latest
    container_name: mcb-milvus
    ports:
      - "19530:19530"
      - "9091:9091"
    volumes:
      - milvus_data:/var/lib/milvus
    environment:
      - COMMON_STORAGETYPE=local
      - ETCD_USE_EMBED=true
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9091/healthz"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    networks:
      - mcb-network
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 4G
        reservations:
          cpus: '1'
          memory: 2G

  # Redis - Cache layer
  redis:
    image: redis:7-alpine
    container_name: mcb-redis
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    command: redis-server --appendonly yes --appendfsync everysec
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5
      start_period: 10s
    networks:
      - mcb-network
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 256M

  # NATS - Event bus
  nats:
    image: nats:2-alpine
    container_name: mcb-nats
    ports:
      - "4222:4222"
      - "8222:8222"
    volumes:
      - nats_data:/data
    command: 
      - nats-server
      - --port
      - "4222"
      - --http_port
      - "8222"
      - --jetstream
      - --store_dir
      - /data
    healthcheck:
      test: ["CMD", "nc", "-z", "localhost", "4222"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    networks:
      - mcb-network
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 256M

  # PostgreSQL - Database (optional, for future use)
  postgres:
    image: postgres:16-alpine
    container_name: mcb-postgres
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    environment:
      - POSTGRES_USER=mcb_user
      - POSTGRES_PASSWORD=mcb_password
      - POSTGRES_DB=mcb_testdb
      - POSTGRES_INITDB_ARGS=-c max_connections=100
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U mcb_user -d mcb_testdb"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    networks:
      - mcb-network
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 512M

volumes:
  ollama_data:
    driver: local
  milvus_data:
    driver: local
  redis_data:
    driver: local
  nats_data:
    driver: local
  postgres_data:
    driver: local

networks:
  mcb-network:
    driver: bridge
