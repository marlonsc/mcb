#!/bin/bash
# =============================================================================
# Pre-commit hook - Uses same Makefile verbs as CI
# =============================================================================
# Install: make install-hooks
# Skip: SKIP_PRE_COMMIT=1 git commit ...
# =============================================================================

set -e

SECONDS=0

# Allow skipping pre-commit for emergencies
if [ "${SKIP_PRE_COMMIT:-}" = "1" ]; then
    echo "⚠️  Pre-commit checks skipped (SKIP_PRE_COMMIT=1)"
    exit 0
fi

echo "Running pre-commit checks..."

# =============================================================================
# Same checks as CI pipeline (fast checks only)
# =============================================================================

echo "  → Lint (Rust 2024 compliance)..."
lint_start=$SECONDS
make lint MCB_CI=1
echo "    ✓ Lint completed in $((SECONDS - lint_start))s"

echo "  → Security audit..."
audit_start=$SECONDS
# Check if cargo-audit is installed, skip if not (CI will catch it)
if command -v cargo-audit &> /dev/null; then
    make audit
    echo "    ✓ Security audit completed in $((SECONDS - audit_start))s"
else
    echo "    ⚠️  cargo-audit not installed, skipping (install: cargo install cargo-audit)"
fi

echo "  → Architecture validation (quick mode)..."
# Quick validation - skip test discovery for speed
validate_start=$SECONDS
if make validate QUICK=1 2>/dev/null; then
    validate_mode="quick"
else
    validate_mode="full"
    make validate
fi
echo "    ✓ Architecture validation (${validate_mode}) completed in $((SECONDS - validate_start))s"

echo ""
echo "✅ Pre-commit checks passed!"
echo "   Total pre-commit time: ${SECONDS}s"
