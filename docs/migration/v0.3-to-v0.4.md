# Migration Guide: v0.3 → v0.4.0

## Overview

v0.4.0 introduces the **Integrated Context System** with knowledge graphs, freshness tracking, and time-travel queries. This guide covers breaking changes, new configuration, and migration steps.

## Breaking Changes

### 1. Configuration Structure

**v0.3 Config**:

```toml
[embedding]
provider = "openai"
model = "text-embedding-3-small"

[vector_store]
provider = "milvus"
```

**v0.4.0 Config** (with new sections):

```toml
[embedding]
provider = "openai"
model = "text-embedding-3-small"

[vector_store]
provider = "milvus"

# NEW: Freshness tracking
[freshness]
default_max_age = 30
[freshness.policies]
api_docs = { max_age = 7, signal = "deprecated" }

# NEW: Context snapshots
[snapshots]
retention_commits = 100
retention_days = 90
frequency = 10

# NEW: Knowledge graph
[graph]
max_nodes = 100000
max_edges = 500000
```

**Migration**: Add new sections to existing config. Old sections remain compatible.

### 2. MCP Tools

**Removed** (consolidated into unified tools):

-   `index_codebase` → `index` (with subcommands)
-   `search_code` → `search` (with freshness filters)
-   `get_indexing_status` → `index status`
-   `clear_index` → `index clear`

**New Tools**:

-   `search` (enhanced with freshness, snapshots, policies)
-   `index` (consolidated operations)
-   `memory` (context storage and retrieval)
-   `session` (workflow session management)
-   `agent` (agent activity logging)
-   `project` (project workflow operations)
-   `vcs` (repository operations)

**Migration**: Update MCP tool calls:

```bash
# v0.3
mcb index_codebase --path /repo

# v0.4.0
mcb index --start --path /repo
```

### 3. Search API

**v0.3 Search**:

```bash
mcb search_code --query "authenticate" --limit 10
```

**v0.4.0 Search** (with freshness):

```bash
# Basic search (backward compatible)
mcb search --query "authenticate" --limit 10

# With freshness filtering
mcb search --query "authenticate" --freshness-max-age 7

# With policy
mcb search --query "authenticate" --policy api_docs

# Time-travel query
mcb search --query "authenticate" --snapshot v0.2.0
```

**Migration**: Existing queries work unchanged. New parameters are optional.

### 4. Index Structure

**v0.3**: Flat index (code chunks + embeddings)

**v0.4.0**: Knowledge graph + index

-   Code chunks indexed as before
-   NEW: Graph relationships (calls, imports, extends)
-   NEW: Freshness metadata (timestamps, staleness signals)
-   NEW: Snapshot versioning (historical snapshots)

**Migration**: Automatic. Reindex codebase to populate graph:

```bash
mcb index --clear
mcb index --start --path /repo
```

## New Features

### 1. Freshness Tracking

Track code context age and staleness:

```bash
# Search with freshness filter
mcb search --query "auth" --freshness-max-age 7

# Returns results with freshness metadata:
# - Last modified: 2 days ago ✓
# - Staleness signal: none
# - Freshness score: 0.95
```

See **ADR-035: Freshness Tracking** for details.

### 2. Time-Travel Queries

Query code as it existed at specific commits/versions:

```bash
# Search in v0.2.0 snapshot
mcb search --query "auth" --snapshot v0.2.0

# Compare with current
mcb search --query "auth" --snapshot v0.2.0 --compare-current
```

See **ADR-045: Context Versioning** for details.

### 3. Knowledge Graph

Understand code relationships:

```bash
# Get function call graph
mcb search --query "authenticate" --include-graph

# Returns:
# - authenticate() calls validate_token()
# - validate_token() calls check_expiry()
# - check_expiry() calls log_event()
```

See **ADR-042: Knowledge Graph** for details.

### 4. Hybrid Search

Combine semantic and keyword search:

```bash
# Hybrid search (semantic + keyword)
mcb search --query "error handling" --mode hybrid

# Semantic only
mcb search --query "error handling" --mode semantic

# Keyword only
mcb search --query "error handling" --mode keyword
```

See **ADR-043: Hybrid Search** for details.

### 5. Policy-Driven Context

Apply policies to context discovery:

```bash
# Apply freshness policy
mcb search --query "API docs" --policy api_docs

# Apply custom policy
mcb search --query "auth" --policy-file policies.toml
```

See **ADR-036: Policies & Validation** for details.

## Migration Steps

### Step 1: Update Configuration

Add new sections to `config/default.toml`:

```toml
# Existing sections (unchanged)
[embedding]
provider = "openai"

[vector_store]
provider = "milvus"

# NEW sections
[freshness]
default_max_age = 30

[freshness.policies]
api_docs = { max_age = 7, signal = "deprecated" }
examples = { max_age = 14, signal = "outdated" }

[snapshots]
retention_commits = 100
retention_days = 90
frequency = 10

[graph]
max_nodes = 100000
max_edges = 500000
```

### Step 2: Reindex Codebase

```bash
# Clear old index
mcb index --clear

# Reindex with new structure
mcb index --start --path /repo

# Wait for completion
mcb index --status
```

### Step 3: Update MCP Tool Calls

Replace old tool names with new consolidated tools:

```bash
# OLD → NEW
index_codebase → index --start
search_code → search
get_indexing_status → index --status
clear_index → index --clear
```

### Step 4: Test Freshness Features

```bash
# Test freshness filtering
mcb search --query "test" --freshness-max-age 7

# Test time-travel (if snapshots exist)
mcb search --query "test" --snapshot v0.3.0

# Test policies
mcb search --query "test" --policy api_docs
```

### Step 5: Update Workflows

If using workflow FSM (Phase 8), update context gates:

```toml
# OLD: No freshness gates
[workflow.states.search]
transitions = ["analyze"]

# NEW: With freshness gates
[workflow.states.search]
transitions = ["analyze"]
context_gates = [
  { type = "freshness", max_age = 7 },
  { type = "policy", name = "api_docs" }
]
```

## Backward Compatibility

### Fully Compatible

-   Existing embeddings and vector store data
-   Existing search queries (without new parameters)
-   Existing configuration (old sections still work)

### Requires Reindexing

-   Knowledge graph relationships (new)
-   Freshness metadata (new)
-   Snapshot versioning (new)

### Requires Code Updates

-   MCP tool names (old names removed)
-   Workflow FSM integration (if using Phase 8)

## Troubleshooting

### Issue: "Unknown tool: index_codebase"

**Cause**: Using v0.3 tool name in v0.4.0

**Solution**: Update to new tool name:

```bash
# OLD (v0.3)
mcb index_codebase --path /repo

# NEW (v0.4.0)
mcb index --start --path /repo
```

### Issue: "Freshness policy not found"

**Cause**: Policy not defined in config

**Solution**: Add policy to config:

```toml
[freshness.policies]
api_docs = { max_age = 7, signal = "deprecated" }
```

### Issue: "Snapshot not found"

**Cause**: Snapshot doesn't exist for requested version

**Solution**: Check available snapshots:

```bash
mcb index --snapshots
```

Or create snapshot manually:

```bash
mcb index --snapshot-create v0.4.0
```

## Related Documentation

-   **ADR-034**: Workflow FSM – State machine for context workflows
-   **ADR-035**: Freshness Tracking – Temporal metadata and staleness signals
-   **ADR-036**: Policies & Validation – Policy enforcement framework
-   **ADR-037**: Compensation & Orchestration – Rollback and recovery patterns
-   **ADR-041**: Context Architecture – System design and layers
-   **ADR-042**: Knowledge Graph – Graph structure and relationships
-   **ADR-043**: Hybrid Search – Search engine design
-   **ADR-044**: Model Selection – Embedding and search model choices
-   **ADR-045**: Context Versioning – Snapshot and temporal query design
-   **ADR-046**: Integration Patterns – MCP tool integration

## Support

For migration issues, see:

-   [`docs/CONFIGURATION.md`](../CONFIGURATION.md) – Configuration reference
-   [`docs/guides/features/INTEGRATED_CONTEXT.md`](../guides/features/INTEGRATED_CONTEXT.md) – Feature overview
-   [`docs/adr/`](../adr/) – Architecture Decision Records
