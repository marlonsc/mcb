---
phase: 06-memory-search
plan: 03
type: execute
wave: 3
depends_on: ["06-02"]
files_modified:
  - crates/mcb-server/src/args.rs
  - crates/mcb-server/src/tools/registry.rs
  - crates/mcb-server/src/tools/router.rs
  - crates/mcb-application/src/use_cases/memory_service.rs
  - crates/mcb-application/src/ports/services.rs
autonomous: true
user_setup: []

must_haves:
  truths:
    - "MCP client can call 'timeline' tool"
    - "MCP client can call 'get_observations' tool"
    - "Timeline returns chronological summary"
    - "GetObservations returns full details"
  artifacts:
    - path: "crates/mcb-server/src/tools/registry.rs"
      provides: "Tool definitions"
      contains: "timeline"
    - path: "crates/mcb-application/src/use_cases/memory_service.rs"
      provides: "Service implementation"
      exports: ["get_timeline", "get_observations"]
  key_links:
    - from: "mcb-server"
      to: "MemoryService"
      via: "ToolHandlers"
---

<objective>
Implement Progressive Disclosure tools (Timeline, GetObservations) and expose them via MCP.

Purpose: Enable the 3-layer memory access workflow (Timeline -> Search -> Detail) to manage context usage.
Output: New MCP tools `timeline` and `get_observations`.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@crates/mcb-server/src/args.rs
@crates/mcb-server/src/tools/registry.rs
@crates/mcb-application/src/use_cases/memory_service.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Define Tool Arguments</name>
  <files>crates/mcb-server/src/args.rs</files>
  <action>
    Add `TimelineArgs` and `GetObservationsArgs` structs.
    - `TimelineArgs`: `limit` (default 50), `before` (timestamp, optional), `after` (timestamp, optional).
    - `GetObservationsArgs`: `ids` (Vec<String>).
    Add validation/schemars attributes.
  </action>
  <verify>
    Check structs export valid JSON schema.
  </verify>
  <done>
    Arguments defined and valid.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement Service Methods</name>
  <files>
    crates/mcb-application/src/use_cases/memory_service.rs
    crates/mcb-application/src/ports/services.rs
  </files>
  <action>
    Add to `MemoryServiceInterface` and `MemoryServiceImpl`:
    1. `async fn get_timeline(&self, limit: usize, before: Option<i64>, after: Option<i64>) -> Result<Vec<Observation>>`
       - Implementation should use `repository.search` with time range filter, empty query/embedding.
    2. `async fn get_observations(&self, ids: Vec<String>) -> Result<Vec<Observation>>`
       - Implementation should loop `repository.get_observation` (or add batch get to repo later, loop is fine for now).
  </action>
  <verify>
    Code compiles.
  </verify>
  <done>
    Service methods implemented.
  </done>
</task>

<task type="auto">
  <name>Task 3: Register and Route Tools</name>
  <files>
    crates/mcb-server/src/tools/registry.rs
    crates/mcb-server/src/tools/router.rs
  </files>
  <action>
    1. Update `ToolDefinitions` in `registry.rs` to include `timeline` and `get_observations`.
    2. Update `create_tool_list`.
    3. Update `route_tool_call` in `router.rs` to handle these tools and call `memory_service`.
  </action>
  <verify>
    Run `cargo run --bin mcb-server` and check `list_tools` output (if possible/manual). Or unit test `create_tool_list`.
  </verify>
  <done>
    Tools exposed via MCP.
  </done>
</task>

</tasks>

<verification>
Unit test in `mcb-server` (or integration test):
1. Call `timeline` -> should return list.
2. Call `get_observations` with IDs from timeline -> should return details.
</verification>

<success_criteria>
- [ ] `timeline` tool available in `list_tools`
- [ ] `get_observations` tool available in `list_tools`
- [ ] `timeline` respects limit and time filters
- [ ] `get_observations` returns correct observations
</success_criteria>

<output>
After completion, create `.planning/phases/06-memory-search/06-03-SUMMARY.md`
</output>
