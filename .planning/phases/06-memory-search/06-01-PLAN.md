---
phase: 06-memory-search
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - crates/mcb-domain/src/ports/repositories/memory.rs
  - crates/mcb-infrastructure/src/repositories/memory.rs
autonomous: true
user_setup: []

must_haves:
  truths:
    - "FTS5 virtual table 'observations_fts' exists in SQLite"
    - "Triggers automatically sync new observations to FTS table"
    - "Deleting an observation removes it from FTS table"
    - "MemoryRepository exposes search_fts method"
  artifacts:
    - path: "crates/mcb-infrastructure/src/repositories/memory.rs"
      provides: "FTS5 implementation"
      contains: "CREATE VIRTUAL TABLE"
    - path: "crates/mcb-domain/src/ports/repositories/memory.rs"
      provides: "FTS search interface"
      exports: ["search_fts"]
  key_links:
    - from: "observations"
      to: "observations_fts"
      via: "SQL Triggers"
      pattern: "CREATE TRIGGER"
---

<objective>
Implement SQLite FTS5 infrastructure and repository interface updates to support hybrid search.

Purpose: Provide the lexical search capability required for Hybrid Search (RRF).
Output: Updated MemoryRepository with FTS capabilities and automatic sync triggers.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/06-memory-search/06-RESEARCH.md
@crates/mcb-infrastructure/src/repositories/memory.rs
@crates/mcb-domain/src/ports/repositories/memory.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update MemoryRepository Trait</name>
  <files>crates/mcb-domain/src/ports/repositories/memory.rs</files>
  <action>
    Add `search_fts` method to `MemoryRepository` trait.
    Signature: `async fn search_fts(&self, query: &str, limit: usize) -> Result<Vec<String>>` (returns IDs).
  </action>
  <verify>
    Check trait definition includes `search_fts`.
  </verify>
  <done>
    Trait updated and compiles.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement FTS5 Schema and Triggers</name>
  <files>crates/mcb-infrastructure/src/repositories/memory.rs</files>
  <action>
    Update `init_schema` in `SqliteMemoryRepository` to:
    1. Create `observations_fts` using `fts5(content, id UNINDEXED)`.
    2. Create triggers `obs_ai`, `obs_ad`, `obs_au` to sync `observations` -> `observations_fts`.
    Reference `06-RESEARCH.md` for exact SQL.
    Ensure `id` matches `observations.id`.
  </action>
  <verify>
    Run `cargo test --package mcb-infrastructure` (schema init should pass).
  </verify>
  <done>
    Schema creation SQL includes FTS table and triggers.
  </done>
</task>

<task type="auto">
  <name>Task 3: Implement search_fts</name>
  <files>crates/mcb-infrastructure/src/repositories/memory.rs</files>
  <action>
    Implement `search_fts` in `SqliteMemoryRepository`.
    Query: `SELECT id FROM observations_fts WHERE observations_fts MATCH ? ORDER BY rank LIMIT ?`.
    Map rows to `Vec<String>`.
    Handle errors appropriately.
  </action>
  <verify>
    Create a test in `crates/mcb-infrastructure/tests/unit/memory_tests.rs` (or similar) that inserts an observation and finds it via `search_fts`.
  </verify>
  <done>
    `search_fts` returns correct IDs for matching text.
  </done>
</task>

</tasks>

<verification>
Create a new integration test `crates/mcb-infrastructure/tests/integration/memory_fts_test.rs`:
1. Initialize repository.
2. Insert observation "The quick brown fox".
3. Search FTS for "fox" -> returns ID.
4. Search FTS for "dog" -> returns empty.
5. Delete observation.
6. Search FTS for "fox" -> returns empty (verifies trigger).
</verification>

<success_criteria>
- [ ] MemoryRepository trait has `search_fts`
- [ ] SQLite schema includes `observations_fts` table
- [ ] Triggers automatically sync data
- [ ] `search_fts` returns matching IDs based on BM25
</success_criteria>

<output>
After completion, create `.planning/phases/06-memory-search/06-01-SUMMARY.md`
</output>
