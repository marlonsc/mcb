# =============================================================================
# CI Pipeline
# =============================================================================
# Uses same Makefile verbs as local development
# Rust 2024 edition lints enabled via CI_MODE=1
# =============================================================================

name: CI

permissions:
  contents: read

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

env:
  CARGO_TERM_COLOR: always

jobs:
  lint:
    name: Lint (Rust 2024)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - run: sudo apt-get update && sudo apt-get install -y protobuf-compiler
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy
      - uses: Swatinem/rust-cache@v2
      - run: make lint CI_MODE=1

  test:
    name: Test (${{ matrix.rust }})
    needs: [lint]
    runs-on: ubuntu-latest
    strategy:
      matrix:
        rust: [stable, beta]
    steps:
      - uses: actions/checkout@v6
      - run: sudo apt-get update && sudo apt-get install -y protobuf-compiler
      - uses: dtolnay/rust-toolchain@master
        with:
          toolchain: ${{ matrix.rust }}
      - uses: Swatinem/rust-cache@v2
      - run: make test

  validate:
    name: Architecture Validation
    needs: [lint]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - run: sudo apt-get update && sudo apt-get install -y protobuf-compiler
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
      - run: make validate STRICT=1
      - name: Check Provider Traits Location
        run: |
          VIOLATIONS=$(grep -r "use mcb_application::ports::providers" crates/mcb-providers/src/ 2>/dev/null || true)
          if [ -n "$VIOLATIONS" ]; then
            echo "VIOLATION: Provider traits should be imported from mcb-domain"
            echo "$VIOLATIONS"
            exit 1
          fi

  golden-tests:
    name: Golden Acceptance Tests
    needs: [test]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - run: sudo apt-get update && sudo apt-get install -y protobuf-compiler
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
      - run: make test SCOPE=golden

  audit:
    name: Security Audit
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
      - run: cargo install cargo-audit --locked
      - run: make audit

  docs:
    name: Documentation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - run: sudo apt-get update && sudo apt-get install -y protobuf-compiler
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
      - run: make docs

  coverage:
    name: Coverage
    needs: [test]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - run: sudo apt-get update && sudo apt-get install -y protobuf-compiler
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
      - run: cargo install cargo-tarpaulin --locked
      - run: make coverage LCOV=1
      - uses: codecov/codecov-action@v5
        with:
          file: ./coverage/lcov.info
          fail_ci_if_error: false

  release-build:
    name: Release (${{ matrix.target }})
    if: github.ref == 'refs/heads/main'
    needs: [test, validate]
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            deps: sudo apt-get update && sudo apt-get install -y protobuf-compiler
          - os: macos-latest
            target: x86_64-apple-darwin
            deps: brew install protobuf
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            deps: choco install protoc
    steps:
      - uses: actions/checkout@v6
      - name: Install dependencies
        run: ${{ matrix.deps }}
        shell: bash
      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}
      - uses: Swatinem/rust-cache@v2
      - run: make build RELEASE=1
      - uses: actions/upload-artifact@v6
        with:
          name: mcp-context-browser-${{ matrix.target }}
          path: target/release/mcp-context-browser${{ matrix.os == 'windows-latest' && '.exe' || '' }}
