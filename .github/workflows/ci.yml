name: CI

permissions:
  contents: read

on:
  push:
    branches: ["main", "feat/*"]
  pull_request:
    branches: ["main"]
  workflow_dispatch:

jobs:
  changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read
    outputs:
      src: ${{ steps.filter.outputs.src }}
      docs: ${{ steps.filter.outputs.docs }}
      ci: ${{ steps.filter.outputs.ci }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            src:
              - 'src/**'
              - 'crates/**'
              - 'tests/**'
              - 'Cargo.toml'
              - 'Cargo.lock'
            docs:
              - 'docs/**'
              - 'scripts/docs/**'
            ci:
              - '.github/workflows/ci.yml'
              - '.github/setup-ci.sh'
              - 'Makefile'
              - 'make/*.mk'

  classify:
    name: Classify PR
    needs: [changes]
    runs-on: ubuntu-latest
    outputs:
      run_full: ${{ steps.classify.outputs.run_full }}
      run_simplified: ${{ steps.classify.outputs.run_simplified }}
    steps:
      - name: Classify PR Type
        id: classify
        run: |
          echo "run_full=true" >> "$GITHUB_OUTPUT"
          echo "run_simplified=false" >> "$GITHUB_OUTPUT"

  lint:
    name: Lint
    needs: [changes, classify]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - run: echo "Linting"

  rust-ci:
    name: Rust CI
    needs: [changes, classify, lint]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - run: echo "Rust CI gate"

  analyze:
    name: Analyze
    needs: [rust-ci]
    if: needs.rust-ci.result == 'success'
    runs-on: ubuntu-latest
    steps:
      - run: echo "Analyze gate"
