name: CI

permissions:
  contents: read

on:
  push:
    branches: ["main", "feat/*"]
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review, converted_to_draft]
    branches: ["main"]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.ref }}
  cancel-in-progress: true

env:
  CARGO_TERM_COLOR: always
  MCB_RUN_DOCKER_INTEGRATION_TESTS: "0"

jobs:
  changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read
    outputs:
      src: ${{ steps.filter.outputs.src }}
      docs: ${{ steps.filter.outputs.docs }}
      ci: ${{ steps.filter.outputs.ci }}
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          persist-credentials: false
      - uses: dorny/paths-filter@de90cc6fb38fc0963ad72b210f1f284cd68cea36 # v3.0.2
        id: filter
        with:
          filters: |
            src:
              - 'src/**'
              - 'crates/**'
              - 'tests/**'
              - 'Cargo.toml'
              - 'Cargo.lock'
            docs:
              - 'docs/**'
              - 'scripts/docs/**'
            ci:
              - '.github/workflows/ci.yml'
              - '.github/setup-ci.sh'
              - 'Makefile'
              - 'make/*.mk'

  classify:
    name: Classify PR
    needs: [changes]
    runs-on: ubuntu-latest
    outputs:
      is_draft: ${{ steps.classify.outputs.is_draft }}
      is_bot: ${{ steps.classify.outputs.is_bot }}
      is_fork: ${{ steps.classify.outputs.is_fork }}
      run_full: ${{ steps.classify.outputs.run_full }}
      run_simplified: ${{ steps.classify.outputs.run_simplified }}
    steps:
      - name: Classify PR Type
        id: classify
        env:
          IS_DRAFT: ${{ github.event_name == 'pull_request' && github.event.pull_request.draft || 'false' }}
          IS_BOT: ${{ github.event_name == 'pull_request' && github.event.pull_request.user.type == 'Bot' || 'false' }}
          IS_FORK: ${{ github.event_name == 'pull_request' && github.event.pull_request.head.repo.fork || 'false' }}
        run: |
          echo "is_draft=${IS_DRAFT}" >> "$GITHUB_OUTPUT"
          echo "is_bot=${IS_BOT}" >> "$GITHUB_OUTPUT"
          echo "is_fork=${IS_FORK}" >> "$GITHUB_OUTPUT"

          if [[ "${IS_DRAFT}" == "false" && "${IS_BOT}" == "false" ]]; then
            echo "run_full=true" >> "$GITHUB_OUTPUT"
            echo "run_simplified=false" >> "$GITHUB_OUTPUT"
          elif [[ "${IS_BOT}" == "true" || "${IS_DRAFT}" == "true" ]]; then
            echo "run_full=false" >> "$GITHUB_OUTPUT"
            echo "run_simplified=true" >> "$GITHUB_OUTPUT"
          else
            echo "run_full=false" >> "$GITHUB_OUTPUT"
            echo "run_simplified=false" >> "$GITHUB_OUTPUT"
          fi

  lint:
    name: Lint (Rust 2024)
    needs: [changes, classify]
    if: |
      (needs.changes.outputs.src == 'true' || needs.changes.outputs.ci == 'true') &&
      ((needs.classify.outputs.run_full == "true" || github.event_name == "push" || github.event_name == "workflow_dispatch") || needs.classify.outputs.run_simplified == 'true')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          persist-credentials: false
          submodules: recursive
      - run: bash .github/setup-ci.sh
      - uses: dtolnay/rust-toolchain@e97e2d8cc328f1b50210efc529dca0028893a2d9 # v1
        with:
          toolchain: stable
          components: rustfmt, clippy
      - uses: Swatinem/rust-cache@779680da715d629ac1d338a641029a2f4372abb5 # v2.8.2
        with:
          shared-key: ci-ubuntu-stable
          save-if: true
      - run: make lint MCB_CI=1

  audit:
    name: Security Audit
    needs: [changes, classify]
    if: |
      (needs.changes.outputs.src == 'true' || needs.changes.outputs.ci == 'true') &&
      (needs.classify.outputs.run_full == "true" || github.event_name == "push" || github.event_name == "workflow_dispatch")
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          persist-credentials: false
          submodules: recursive
      - run: bash .github/setup-ci.sh --install-audit
      - uses: dtolnay/rust-toolchain@e97e2d8cc328f1b50210efc529dca0028893a2d9 # v1
        with:
          toolchain: stable
      - uses: Swatinem/rust-cache@779680da715d629ac1d338a641029a2f4372abb5 # v2.8.2
        with:
          shared-key: ci-ubuntu-stable
          save-if: false
      - run: make audit

