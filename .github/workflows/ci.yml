---
# =============================================================================
# CI Pipeline
# =============================================================================
# Uses same Makefile verbs as local development
# =============================================================================

name: CI

permissions:
  contents: "read"

on: # yamllint disable-line rule:truthy
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review, converted_to_draft]
    branches:
      - main

concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.ref }}
  cancel-in-progress: true

env:
  CARGO_TERM_COLOR: always
  MCB_RUN_DOCKER_INTEGRATION_TESTS: "0"

jobs:
  changes:
    name: Detect Changes
    timeout-minutes: 5
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read
    outputs:
      src: ${{ steps.filter.outputs.src }}
      docs: ${{ steps.filter.outputs.docs }}
      ci: ${{ steps.filter.outputs.ci }}
    steps:
      - uses: dorny/paths-filter@de90cc6fb38fc0963ad72b210f1f284cd68cea36 # v3.0.2
        id: filter
        with:
          filters: |
            src:
              - 'src/**'
              - 'crates/**'
              - 'tests/**'
              - 'Cargo.toml'
              - 'Cargo.lock'
            docs:
              - 'docs/**'
              - 'scripts/docs/**'
            ci:
              - '.github/workflows/ci.yml'
              - '.github/setup-ci.sh'
              - 'Makefile'
              - 'make/*.mk'

  classify:
    name: Classify PR
    timeout-minutes: 5
    runs-on: ubuntu-latest
    outputs:
      is_draft: ${{ steps.classify.outputs.is_draft }}
      is_bot: ${{ steps.classify.outputs.is_bot }}
      is_fork: ${{ steps.classify.outputs.is_fork }}
      run_full: ${{ steps.classify.outputs.run_full }}
      run_simplified: ${{ steps.classify.outputs.run_simplified }}
    steps:
      - name: Classify PR Type
        id: classify
        env:
          IS_DRAFT: ${{ github.event.pull_request.draft }}
          IS_BOT: ${{ github.event.pull_request.user.type == 'Bot' }}
          IS_FORK: ${{ github.event.pull_request.head.repo.fork }}
        run: |
          echo "is_draft=${IS_DRAFT}" >> "$GITHUB_OUTPUT"
          echo "is_bot=${IS_BOT}" >> "$GITHUB_OUTPUT"
          echo "is_fork=${IS_FORK}" >> "$GITHUB_OUTPUT"

          # Full suite: non-draft human PRs targeting main
          if [[ "${IS_DRAFT}" == "false" && "${IS_BOT}" == "false" ]]; then
            echo "run_full=true" >> "$GITHUB_OUTPUT"
            echo "run_simplified=false" >> "$GITHUB_OUTPUT"
          elif [[ "${IS_BOT}" == "true" ]]; then
            # Simplified bot policy: Linux + stable only
            echo "run_full=false" >> "$GITHUB_OUTPUT"
            echo "run_simplified=true" >> "$GITHUB_OUTPUT"
          else
            # Draft or other: skip heavy jobs
            echo "run_full=false" >> "$GITHUB_OUTPUT"
            echo "run_simplified=false" >> "$GITHUB_OUTPUT"
          fi

  lint:
    name: Lint (Rust 2024)
    timeout-minutes: 10
    needs: [changes, classify]
    if: |
      (needs.changes.outputs.src == 'true' || needs.changes.outputs.ci == 'true') &&
      (needs.classify.outputs.run_full == 'true' || needs.classify.outputs.run_simplified == 'true')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1
        with:
          persist-credentials: false
      - run: bash .github/setup-ci.sh
      - uses: dtolnay/rust-toolchain@e97e2d8cc328f1b50210efc529dca0028893a2d9 # v1
        with:
          toolchain: stable
          components: rustfmt, clippy
      - uses: Swatinem/rust-cache@779680da715d629ac1d338a641029a2f4372abb5 # v2.8.2
        with:
          save-if: false
      - run: make lint MCB_CI=1

  test:
    name: Test (${{ matrix.os }}, ${{ matrix.rust }})
    needs: [changes, classify, lint]
    if: |
      (needs.changes.outputs.src == 'true' || needs.changes.outputs.ci == 'true') &&
      (needs.classify.outputs.run_full == 'true' || needs.classify.outputs.run_simplified == 'true')
    runs-on: ${{ matrix.os }}
    timeout-minutes: 30
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest]
        rust: [stable]
        # Full matrix: add macOS, Windows, and beta for non-draft human PRs
        include:
          - os: ubuntu-latest
            rust: beta
            if_key: ${{ needs.classify.outputs.run_full == 'true' }}
          - os: macos-latest
            rust: stable
            if_key: ${{ needs.classify.outputs.run_full == 'true' }}
          - os: windows-latest
            rust: stable
            if_key: ${{ needs.classify.outputs.run_full == 'true' }}
    steps:
      - name: Enable long paths (Windows)
        if: runner.os == 'Windows'
        run: git config --system core.longpaths true
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1
        with:
          persist-credentials: false
      - name: Install dependencies (Unix)
        if: runner.os != 'Windows'
        run: bash .github/setup-ci.sh
      - name: Install protoc (Windows)
        if: runner.os == 'Windows'
        run: choco install protoc -y
      - uses: dtolnay/rust-toolchain@e97e2d8cc328f1b50210efc529dca0028893a2d9 # v1
        with:
          toolchain: ${{ matrix.rust }}
      - uses: Swatinem/rust-cache@779680da715d629ac1d338a641029a2f4372abb5 # v2.8.2
        with:
          save-if: false
      # Skip if matrix exclusion applies
      - name: Run tests
        if: matrix.if_key != 'false'
        run: make test THREADS=4

  startup-smoke:
    name: Startup Smoke (DDL/Init)
    needs: [changes, classify, lint]
    if: |
      (needs.changes.outputs.src == 'true' || needs.changes.outputs.ci == 'true') &&
      (needs.classify.outputs.run_full == 'true' || needs.classify.outputs.run_simplified == 'true')
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1
        with:
          persist-credentials: false
      - run: bash .github/setup-ci.sh
      - uses: dtolnay/rust-toolchain@e97e2d8cc328f1b50210efc529dca0028893a2d9 # v1
        with:
          toolchain: stable
      - uses: Swatinem/rust-cache@779680da715d629ac1d338a641029a2f4372abb5 # v2.8.2
        with:
          save-if: false
      - run: make test SCOPE=startup

  validate:
    name: Architecture Validation
    needs: [changes, classify, lint, startup-smoke]
    if: |
      (needs.changes.outputs.src == 'true' || needs.changes.outputs.ci == 'true') &&
      (needs.classify.outputs.run_full == 'true' || needs.classify.outputs.run_simplified == 'true')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1
        with:
          persist-credentials: false
      - run: bash .github/setup-ci.sh
      - uses: dtolnay/rust-toolchain@e97e2d8cc328f1b50210efc529dca0028893a2d9 # v1
        with:
          toolchain: stable
      - uses: Swatinem/rust-cache@779680da715d629ac1d338a641029a2f4372abb5 # v2.8.2
        with:
          save-if: false
      - run: make validate
      - name: Check Provider Traits Location
        run: |
          VIOLATIONS=$(
            grep -r "use mcb_application::ports::providers" \
              crates/mcb-providers/src/ 2>/dev/null || true
          )
          if [ -n "$VIOLATIONS" ]; then
            echo "VIOLATION: Provider traits should be imported from mcb-domain"
            echo "$VIOLATIONS"
            exit 1
          fi

  golden-tests:
    name: Golden Acceptance Tests
    needs: [changes, classify, test]
    if: |
      (needs.changes.outputs.src == 'true' || needs.changes.outputs.ci == 'true') &&
      needs.classify.outputs.run_full == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1
        with:
          persist-credentials: false
      - run: bash .github/setup-ci.sh
      - uses: dtolnay/rust-toolchain@e97e2d8cc328f1b50210efc529dca0028893a2d9 # v1
        with:
          toolchain: stable
      - uses: Swatinem/rust-cache@779680da715d629ac1d338a641029a2f4372abb5 # v2.8.2
        with:
          save-if: false
      - run: make test SCOPE=golden THREADS=2

  audit:
    name: Security Audit
    timeout-minutes: 10
    needs: [changes]
    if: needs.changes.outputs.src == 'true' || needs.changes.outputs.ci == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1
        with:
          persist-credentials: false
      - run: bash .github/setup-ci.sh --install-audit
      - uses: dtolnay/rust-toolchain@e97e2d8cc328f1b50210efc529dca0028893a2d9 # v1
        with:
          toolchain: stable
      - uses: Swatinem/rust-cache@779680da715d629ac1d338a641029a2f4372abb5 # v2.8.2
        with:
          save-if: ${{ github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop' }}
      - run: make audit

  analyze:
    name: Analyze (${{ matrix.language }})
    timeout-minutes: 15
    needs: [changes, rust-ci]
    if: |
      always() &&
      (needs.changes.outputs.src == 'true' || needs.changes.outputs.ci == 'true')
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
    strategy:
      fail-fast: false
      matrix:
        language: [rust]
    env:
      CODEQL_ENABLE_EXPERIMENTAL_FEATURES: "true"
    steps:
      - name: Checkout repository
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1
        with:
          persist-credentials: false
      - name: Initialize CodeQL
        uses: github/codeql-action/init@45cbd0c69e560cd9e7cd7f8c32362050c9b7ded2 # v3.28.13
        with:
          languages: ${{ matrix.language }}
          config-file: ./.github/codeql-config.yml
      - name: Setup Rust
        uses: dtolnay/rust-toolchain@e97e2d8cc328f1b50210efc529dca0028893a2d9 # v1
        with:
          toolchain: stable
      - name: Autobuild
        uses: github/codeql-action/autobuild@45cbd0c69e560cd9e7cd7f8c32362050c9b7ded2 # v3.28.13
      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@45cbd0c69e560cd9e7cd7f8c32362050c9b7ded2 # v3.28.13
        with:
          category: "/language:${{ matrix.language }}"

  validate-docs:
    name: Validate Documentation
    timeout-minutes: 10
    runs-on: ubuntu-latest
    needs: [changes]
    if: needs.changes.outputs.docs == 'true' || needs.changes.outputs.ci == 'true'
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1
        with:
          persist-credentials: false
      - run: make docs-check
      - run: bash .github/setup-ci.sh
      - uses: dtolnay/rust-toolchain@e97e2d8cc328f1b50210efc529dca0028893a2d9 # v1
        with:
          toolchain: stable
      - run: |
          sudo apt-get update
          sudo apt-get install -y nodejs npm
          npm install -g markdownlint-cli
      - run: make docs-validate QUICK=1

  docs-diagrams:
    name: Generate Diagrams
    timeout-minutes: 10
    runs-on: ubuntu-latest
    needs: [changes]
    if: needs.changes.outputs.docs == 'true' || needs.changes.outputs.src == 'true' || needs.changes.outputs.ci == 'true'
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1
        with:
          persist-credentials: false
      - uses: actions/setup-java@be666c2fcd27ec809703dec50e508c2fdc7f6654 # v5.2.0
        with:
          java-version: "17"
          distribution: "temurin"
      - name: Install PlantUML
        run: sudo apt-get update && sudo apt-get install -y plantuml
      - run: make diagrams
      - uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: architecture-diagrams
          path: docs/architecture/diagrams/generated/
          retention-days: 30
          include-hidden-files: false

  rust-ci:
    name: Rust CI (PR consolidated)
    timeout-minutes: 40
    runs-on: ubuntu-latest
    needs: [changes, classify, lint, test, startup-smoke, validate, audit, golden-tests, coverage, release-build]
    if: always()
    steps:
      - name: Evaluate Required Checks
        env:
          IS_DRAFT: ${{ needs.classify.outputs.is_draft }}
          IS_BOT: ${{ needs.classify.outputs.is_bot }}
          RUN_FULL: ${{ needs.classify.outputs.run_full }}
          RUN_SIMPLIFIED: ${{ needs.classify.outputs.run_simplified }}
          LINT_RESULT: ${{ needs.lint.result }}
          TEST_RESULT: ${{ needs.test.result }}
          STARTUP_RESULT: ${{ needs.startup-smoke.result }}
          VALIDATE_RESULT: ${{ needs.validate.result }}
          AUDIT_RESULT: ${{ needs.audit.result }}
          GOLDEN_RESULT: ${{ needs.golden-tests.result }}
          COVERAGE_RESULT: ${{ needs.coverage.result }}
          RELEASE_BUILD_RESULT: ${{ needs.release-build.result }}
        run: |
          echo "=== PR Classification ==="
          echo "Is Draft: $IS_DRAFT"
          echo "Is Bot: $IS_BOT"
          echo "Run Full Suite: $RUN_FULL"
          echo "Run Simplified Suite: $RUN_SIMPLIFIED"
          echo ""
          echo "=== Job Results ==="
          echo "Lint: $LINT_RESULT"
          echo "Test: $TEST_RESULT"
          echo "Startup Smoke: $STARTUP_RESULT"
          echo "Validate: $VALIDATE_RESULT"
          echo "Audit: $AUDIT_RESULT"
          echo "Golden: $GOLDEN_RESULT"
          echo "Coverage: $COVERAGE_RESULT"
          echo "Release Build: $RELEASE_BUILD_RESULT"
          echo ""
          
          # Draft PRs: all heavy jobs should be skipped, gate succeeds
          if [[ "$IS_DRAFT" == "true" ]]; then
            echo "✓ Draft PR - gate check passed (no heavy jobs required)"
            exit 0
          fi
          
          # Simplified bot policy: require lint + test + startup + validate
          if [[ "$RUN_SIMPLIFIED" == "true" ]]; then
            echo "=== Bot PR Policy (Simplified) ==="
            if [[ "$LINT_RESULT" != "success" ]]; then
              echo "✗ Lint failed"
              exit 1
            fi
            if [[ "$TEST_RESULT" != "success" ]]; then
              echo "✗ Test failed"
              exit 1
            fi
            if [[ "$STARTUP_RESULT" != "success" ]]; then
              echo "✗ Startup smoke failed"
              exit 1
            fi
            if [[ "$VALIDATE_RESULT" != "success" ]]; then
              echo "✗ Validate failed"
              exit 1
            fi
            echo "✓ Bot PR - simplified checks passed"
            exit 0
          fi
          
          # Full suite for human ready PRs
          if [[ "$RUN_FULL" == "true" ]]; then
            echo "=== Full Suite Policy (Human Ready PR) ==="
            REQUIRED_JOBS=(
              "LINT_RESULT"
              "TEST_RESULT"
              "STARTUP_RESULT"
              "VALIDATE_RESULT"
              "AUDIT_RESULT"
              "GOLDEN_RESULT"
              "COVERAGE_RESULT"
              "RELEASE_BUILD_RESULT"
            )
            
            FAILED=0
            for job in "${REQUIRED_JOBS[@]}"; do
              result="${!job}"
              if [[ "$result" != "success" && "$result" != "skipped" ]]; then
                echo "✗ $job failed or was cancelled: $result"
                FAILED=1
              fi
            done
            
            if [[ $FAILED -eq 1 ]]; then
              echo "✗ Full suite check failed"
              exit 1
            fi
            
            echo "✓ Full suite - all required checks passed"
            exit 0
          fi
          
          echo "✗ Unexpected classification state"
          exit 1

  coverage:
    name: Coverage
    needs: [changes, classify, test]
    if: |
      (needs.changes.outputs.src == 'true' || needs.changes.outputs.ci == 'true') &&
      needs.classify.outputs.run_full == 'true' &&
      needs.classify.outputs.is_fork == 'false'
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1
        with:
          persist-credentials: false
      - run: bash .github/setup-ci.sh --install-coverage
      - uses: dtolnay/rust-toolchain@e97e2d8cc328f1b50210efc529dca0028893a2d9 # v1
        with:
          toolchain: stable
      - uses: Swatinem/rust-cache@779680da715d629ac1d338a641029a2f4372abb5 # v2.8.2
        with:
          save-if: false
      - run: make coverage MCB_CI=1 THREADS=4
      - uses: codecov/codecov-action@671740ac38dd9b0130fbe1cec585b89eea48d3de # v5.5.2
        with:
          files: ./coverage/lcov.info
          fail_ci_if_error: false

  release-build:
    name: Build Release Binaries (${{ matrix.target }})
    timeout-minutes: 30
    needs: [changes, classify, test, validate, audit]
    if: |
      (needs.changes.outputs.src == 'true' || needs.changes.outputs.ci == 'true') &&
      needs.classify.outputs.run_full == 'true'
    runs-on: ${{ matrix.os }}
    permissions:
      contents: read
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            artifact_name: mcb
            asset_name: mcb-x86_64-linux-gnu
          - os: macos-latest
            target: x86_64-apple-darwin
            artifact_name: mcb
            asset_name: mcb-x86_64-macos
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            artifact_name: mcb.exe
            asset_name: mcb-x86_64-windows.exe
    steps:
      - name: Enable long paths (Windows)
        if: runner.os == 'Windows'
        run: git config --system core.longpaths true
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1
        with:
          persist-credentials: false
      - name: Install dependencies (Unix)
        if: runner.os != 'Windows'
        run: bash .github/setup-ci.sh
      - name: Install protoc (Windows)
        if: runner.os == 'Windows'
        run: choco install protoc -y
      - uses: dtolnay/rust-toolchain@e97e2d8cc328f1b50210efc529dca0028893a2d9 # v1
        with:
          toolchain: stable
          targets: ${{ matrix.target }}
      - run: make build RELEASE=1
      - name: Create dist directory
        run: mkdir -p dist
      - name: Copy artifact (Unix)
        if: runner.os != 'Windows'
        env:
          ARTIFACT: ${{ matrix.artifact_name }}
          ASSET: ${{ matrix.asset_name }}
        run: cp "target/release/$ARTIFACT" "dist/$ASSET"
      - name: Copy artifact (Windows)
        if: runner.os == 'Windows'
        run: Copy-Item "target\release\${{ matrix.artifact_name }}" "dist\${{ matrix.asset_name }}"
        shell: pwsh
      - name: Upload artifact
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: release-artifacts-${{ matrix.target }}
          path: dist/${{ matrix.asset_name }}
          retention-days: 7
          include-hidden-files: false

  auto-merge-dependabot:
    name: Auto-Merge Dependabot
    timeout-minutes: 5
    runs-on: ubuntu-latest
    if: github.event.pull_request.user.login == 'dependabot[bot]'
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Fetch Dependabot metadata
        id: metadata
        uses: dependabot/fetch-metadata@21025c705c08248db411dc16f3619e6b5f9ea21a # v2.5.0
        with:
          github-token: "${{ secrets.GITHUB_TOKEN }}"

      - name: Enable auto-merge for patch and minor updates
        if: >-
          steps.metadata.outputs.update-type == 'version-update:semver-patch' ||
          steps.metadata.outputs.update-type == 'version-update:semver-minor'
        run: gh pr merge --auto --squash "$PR_URL"
        env:
          PR_URL: ${{ github.event.pull_request.html_url }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Auto-approve major updates (review only, no merge)
        if: >-
          steps.metadata.outputs.update-type == 'version-update:semver-major'
        env:
          PR_URL: ${{ github.event.pull_request.html_url }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          DEP_NAMES: ${{ steps.metadata.outputs.dependency-names }}
        run: |
          echo "::notice ::Major update detected: $DEP_NAMES"
          echo "Major updates require manual review and merge."
          gh pr comment "$PR_URL" --body \
            "**Major version update detected.** This PR requires manual review before merging."
