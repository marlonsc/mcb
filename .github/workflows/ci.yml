name: CI
permissions:
  contents: read
'on':
  push:
    branches:
      - main
      - feat/*
  pull_request:
    types:
      - opened
      - synchronize
      - reopened
      - ready_for_review
      - converted_to_draft
  workflow_dispatch: null
concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.ref }}
  cancel-in-progress: true
env:
  CARGO_TERM_COLOR: always
  MCB_RUN_DOCKER_INTEGRATION_TESTS: '0'
jobs:
  changes:
    name: Detect Changes
    timeout-minutes: 5
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read
    outputs:
      src: ${{ steps.filter.outputs.src }}
      docs: ${{ steps.filter.outputs.docs }}
      ci: ${{ steps.filter.outputs.ci }}
    steps:
      - uses: dorny/paths-filter@de90cc6fb38fc0963ad72b210f1f284cd68cea36
        id: filter
        with:
          filters: "src:\n  - 'src/**'\n  - 'crates/**'\n  - 'tests/**'\n  - 'Cargo.toml'\n\
            \  - 'Cargo.lock'\ndocs:\n  - 'docs/**'\n  - 'scripts/docs/**'\nci:\n\
            \  - '.github/workflows/ci.yml'\n  - '.github/setup-ci.sh'\n  - 'Makefile'\n\
            \  - 'make/*.mk'\n"
  classify:
    name: Classify PR
    timeout-minutes: 5
    runs-on: ubuntu-latest
    outputs:
      is_draft: ${{ steps.classify.outputs.is_draft }}
      is_bot: ${{ steps.classify.outputs.is_bot }}
      is_fork: ${{ steps.classify.outputs.is_fork }}
      run_full: ${{ steps.classify.outputs.run_full }}
      run_simplified: ${{ steps.classify.outputs.run_simplified }}
    steps:
      - name: Classify PR Type
        id: classify
        env:
          IS_DRAFT: ${{ github.event_name == "pull_request" && github.event.pull_request.draft
            || "false" }}
          IS_BOT: ${{ github.event_name == 'pull_request' && github.event.pull_request.user.type
            == 'Bot' || 'false' }}
          IS_FORK: ${{ github.event_name == "pull_request" && github.event.pull_request.head.repo.fork
            || "false" }}
        run: "{\n  echo \"is_draft=${IS_DRAFT}\"\n  echo \"is_bot=${IS_BOT}\"\n  echo\
          \ \"is_fork=${IS_FORK}\"\n} >> \"$GITHUB_OUTPUT\"\n\nif [[ \"${IS_DRAFT}\"\
          \ == \"false\" && \"${IS_BOT}\" == \"false\" ]]; then\n  echo \"run_full=true\"\
          \ >> \"$GITHUB_OUTPUT\"\n  echo \"run_simplified=false\" >> \"$GITHUB_OUTPUT\"\
          \nelif [[ \"${IS_BOT}\" == \"true\" || \"${IS_DRAFT}\" == \"true\" ]]; then\n\
          \  echo \"run_full=false\" >> \"$GITHUB_OUTPUT\"\n  echo \"run_simplified=true\"\
          \ >> \"$GITHUB_OUTPUT\"\nelse\n  echo \"run_full=false\" >> \"$GITHUB_OUTPUT\"\
          \n  echo \"run_simplified=false\" >> \"$GITHUB_OUTPUT\"\nfi\n"
  lint:
    name: Lint (Rust 2024)
    timeout-minutes: 10
    needs:
      - changes
      - classify
    if: '(needs.changes.outputs.src == ''true'' || needs.changes.outputs.ci == ''true'')
      &&

      ((needs.classify.outputs.run_full == "true" || github.event_name == "push" ||
      github.event_name == "workflow_dispatch") || needs.classify.outputs.run_simplified
      == ''true'')

      '
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd
        with:
          persist-credentials: false
          submodules: recursive
      - run: bash .github/setup-ci.sh
      - uses: dtolnay/rust-toolchain@e97e2d8cc328f1b50210efc529dca0028893a2d9
        with:
          toolchain: stable
          components: rustfmt, clippy
      - uses: Swatinem/rust-cache@779680da715d629ac1d338a641029a2f4372abb5
        with:
          shared-key: ci-ubuntu-stable
          save-if: true
      - run: make lint MCB_CI=1
  audit:
    name: Security Audit
    timeout-minutes: 10
    needs:
      - changes
      - classify
    if: (needs.changes.outputs.src == 'true' || needs.changes.outputs.ci == 'true')
      && (needs.classify.outputs.run_full == "true" || github.event_name == "push"
      || github.event_name == "workflow_dispatch")
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd
        with:
          persist-credentials: false
          submodules: recursive
      - run: bash .github/setup-ci.sh --install-audit
      - uses: dtolnay/rust-toolchain@e97e2d8cc328f1b50210efc529dca0028893a2d9
        with:
          toolchain: stable
      - uses: Swatinem/rust-cache@779680da715d629ac1d338a641029a2f4372abb5
        with:
          shared-key: ci-ubuntu-stable
          save-if: false
      - run: make audit
  validate-docs:
    name: Validate Documentation
    timeout-minutes: 10
    runs-on: ubuntu-latest
    needs:
      - changes
      - classify
    if: (needs.changes.outputs.docs == 'true' || needs.changes.outputs.ci == 'true')
      && (needs.classify.outputs.run_full == "true" || github.event_name == "push"
      || github.event_name == "workflow_dispatch")
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd
        with:
          persist-credentials: false
          submodules: recursive
      - run: make docs-check
      - run: bash .github/setup-ci.sh
      - uses: dtolnay/rust-toolchain@e97e2d8cc328f1b50210efc529dca0028893a2d9
        with:
          toolchain: stable
      - run: 'sudo apt-get update

          sudo apt-get install -y nodejs npm

          npm install -g markdownlint-cli

          '
      - run: make docs-validate QUICK=1
  docs-diagrams:
    name: Generate Diagrams
    timeout-minutes: 10
    runs-on: ubuntu-latest
    needs:
      - changes
      - classify
    if: (needs.changes.outputs.docs == 'true' || needs.changes.outputs.src == 'true'
      || needs.changes.outputs.ci == 'true') && (needs.classify.outputs.run_full ==
      "true" || github.event_name == "push" || github.event_name == "workflow_dispatch")
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd
        with:
          persist-credentials: false
          submodules: recursive
      - uses: actions/setup-java@be666c2fcd27ec809703dec50e508c2fdc7f6654
        with:
          java-version: '17'
          distribution: temurin
      - name: Install PlantUML
        run: sudo apt-get update && sudo apt-get install -y plantuml
      - run: make diagrams
      - uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f
        with:
          name: architecture-diagrams
          path: docs/architecture/diagrams/generated/
          retention-days: 30
          include-hidden-files: false
  test-linux:
    name: Test (ubuntu-latest, Rust stable)
    needs:
      - changes
      - classify
      - lint
    if: '(needs.changes.outputs.src == ''true'' || needs.changes.outputs.ci == ''true'')
      &&

      ((needs.classify.outputs.run_full == "true" || github.event_name == "push" ||
      github.event_name == "workflow_dispatch") || needs.classify.outputs.run_simplified
      == ''true'')

      '
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd
        with:
          persist-credentials: false
          submodules: recursive
      - run: bash .github/setup-ci.sh
      - uses: dtolnay/rust-toolchain@e97e2d8cc328f1b50210efc529dca0028893a2d9
        with:
          toolchain: stable
      - uses: Swatinem/rust-cache@779680da715d629ac1d338a641029a2f4372abb5
        with:
          shared-key: ci-ubuntu-stable
          save-if: false
      - name: Startup Smoke (DDL/Init)
        run: make test SCOPE=startup THREADS=4
      - name: Full Test Suite
        run: make test THREADS=4
  test-cross:
    name: Test (${{ matrix.os }}, Rust ${{ matrix.rust }})
    needs:
      - changes
      - classify
      - test-linux
    if: '(needs.changes.outputs.src == ''true'' || needs.changes.outputs.ci == ''true'')
      &&

      (needs.classify.outputs.run_full == "true" || github.event_name == "push" ||
      github.event_name == "workflow_dispatch")

      '
    runs-on: ${{ matrix.os }}
    timeout-minutes: 30
    continue-on-error: ${{ matrix.rust == 'beta' }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            rust: beta
          - os: macos-latest
            rust: stable
          - os: windows-latest
            rust: stable
    steps:
      - name: Enable long paths (Windows)
        if: runner.os == 'Windows'
        run: git config --system core.longpaths true
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd
        with:
          persist-credentials: false
          submodules: recursive
      - name: Install dependencies (Unix)
        if: runner.os != 'Windows'
        run: bash .github/setup-ci.sh
      - name: Install protoc (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        env:
          PROTOC_VERSION: '29.3'
          PROTOC_SHA256: 57ea59e9f551ad8d71ffaa9b5cfbe0ca1f4e720972a1db7ec2d12ab44bff9383
        run: "$url = \"https://github.com/protocolbuffers/protobuf/releases/download/v${env:PROTOC_VERSION}/protoc-${env:PROTOC_VERSION}-win64.zip\"\
          \n$zip = \"$env:TEMP\\protoc.zip\"\nInvoke-WebRequest -Uri $url -OutFile\
          \ $zip -ErrorAction Stop\n$hash = (Get-FileHash $zip -Algorithm SHA256).Hash.ToLower()\n\
          if ($hash -ne $env:PROTOC_SHA256) {\n  throw \"protoc checksum mismatch:\
          \ expected $($env:PROTOC_SHA256), got $hash\"\n}\nExpand-Archive $zip -DestinationPath\
          \ \"$env:TEMP\\protoc\" -Force\nAdd-Content -Path $env:GITHUB_PATH -Value\
          \ \"$env:TEMP\\protoc\\bin\"\n"
      - uses: dtolnay/rust-toolchain@e97e2d8cc328f1b50210efc529dca0028893a2d9
        with:
          toolchain: ${{ matrix.rust }}
      - uses: Swatinem/rust-cache@779680da715d629ac1d338a641029a2f4372abb5
        with:
          save-if: false
      - run: make test THREADS=4
  validate:
    name: Architecture Validation
    needs:
      - changes
      - classify
      - lint
    if: '(needs.changes.outputs.src == ''true'' || needs.changes.outputs.ci == ''true'')
      &&

      ((needs.classify.outputs.run_full == "true" || github.event_name == "push" ||
      github.event_name == "workflow_dispatch") || needs.classify.outputs.run_simplified
      == ''true'')

      '
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd
        with:
          persist-credentials: false
          submodules: recursive
      - run: bash .github/setup-ci.sh
      - uses: dtolnay/rust-toolchain@e97e2d8cc328f1b50210efc529dca0028893a2d9
        with:
          toolchain: stable
      - uses: Swatinem/rust-cache@779680da715d629ac1d338a641029a2f4372abb5
        with:
          shared-key: ci-ubuntu-stable
          save-if: false
      - run: make validate
        env:
          RUST_MIN_STACK: 16777216
  golden-tests:
    name: Golden Acceptance Tests
    needs:
      - changes
      - classify
      - test-linux
    if: '(needs.changes.outputs.src == ''true'' || needs.changes.outputs.ci == ''true'')
      &&

      (needs.classify.outputs.run_full == "true" || github.event_name == "push" ||
      github.event_name == "workflow_dispatch")

      '
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd
        with:
          persist-credentials: false
          submodules: recursive
      - run: bash .github/setup-ci.sh
      - uses: dtolnay/rust-toolchain@e97e2d8cc328f1b50210efc529dca0028893a2d9
        with:
          toolchain: stable
      - uses: Swatinem/rust-cache@779680da715d629ac1d338a641029a2f4372abb5
        with:
          shared-key: ci-ubuntu-stable
          save-if: false
      - run: make test SCOPE=golden THREADS=2
  coverage:
    name: Coverage
    needs:
      - changes
      - classify
      - test-linux
    if: '(needs.changes.outputs.src == ''true'' || needs.changes.outputs.ci == ''true'')
      &&

      (needs.classify.outputs.run_full == "true" || github.event_name == "push" ||
      github.event_name == "workflow_dispatch") &&

      needs.classify.outputs.is_fork == ''false''

      '
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd
        with:
          persist-credentials: false
          submodules: recursive
      - run: bash .github/setup-ci.sh --install-coverage
      - uses: dtolnay/rust-toolchain@e97e2d8cc328f1b50210efc529dca0028893a2d9
        with:
          toolchain: stable
      - uses: Swatinem/rust-cache@779680da715d629ac1d338a641029a2f4372abb5
        with:
          shared-key: ci-ubuntu-stable
          save-if: false
      - run: make coverage MCB_CI=1 THREADS=4
      - uses: codecov/codecov-action@671740ac38dd9b0130fbe1cec585b89eea48d3de
        with:
          files: ./coverage/lcov.info
          fail_ci_if_error: false
  release-build:
    name: Build Release Binaries (${{ matrix.target }})
    timeout-minutes: 30
    needs:
      - changes
      - classify
      - test-linux
      - validate
      - audit
    if: '(needs.changes.outputs.src == ''true'' || needs.changes.outputs.ci == ''true'')
      &&

      (needs.classify.outputs.run_full == "true" || github.event_name == "push" ||
      github.event_name == "workflow_dispatch")

      '
    runs-on: ${{ matrix.os }}
    permissions:
      contents: read
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            artifact_name: mcb
            asset_name: mcb-x86_64-linux-gnu
          - os: macos-latest
            target: x86_64-apple-darwin
            artifact_name: mcb
            asset_name: mcb-x86_64-macos
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            artifact_name: mcb.exe
            asset_name: mcb-x86_64-windows.exe
    steps:
      - name: Enable long paths (Windows)
        if: runner.os == 'Windows'
        run: git config --system core.longpaths true
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd
        with:
          persist-credentials: false
          submodules: recursive
      - name: Install dependencies (Unix)
        if: runner.os != 'Windows'
        run: bash .github/setup-ci.sh
      - name: Install protoc (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        env:
          PROTOC_VERSION: '29.3'
          PROTOC_SHA256: 57ea59e9f551ad8d71ffaa9b5cfbe0ca1f4e720972a1db7ec2d12ab44bff9383
        run: "$url = \"https://github.com/protocolbuffers/protobuf/releases/download/v${env:PROTOC_VERSION}/protoc-${env:PROTOC_VERSION}-win64.zip\"\
          \n$zip = \"$env:TEMP\\protoc.zip\"\nInvoke-WebRequest -Uri $url -OutFile\
          \ $zip -ErrorAction Stop\n$hash = (Get-FileHash $zip -Algorithm SHA256).Hash.ToLower()\n\
          if ($hash -ne $env:PROTOC_SHA256) {\n  throw \"protoc checksum mismatch:\
          \ expected $($env:PROTOC_SHA256), got $hash\"\n}\nExpand-Archive $zip -DestinationPath\
          \ \"$env:TEMP\\protoc\" -Force\nAdd-Content -Path $env:GITHUB_PATH -Value\
          \ \"$env:TEMP\\protoc\\bin\"\n"
      - uses: dtolnay/rust-toolchain@e97e2d8cc328f1b50210efc529dca0028893a2d9
        with:
          toolchain: stable
          targets: ${{ matrix.target }}
      - run: make build RELEASE=1
      - name: Create dist directory
        run: mkdir -p dist
      - name: Copy artifact (Unix)
        if: runner.os != 'Windows'
        env:
          ARTIFACT: ${{ matrix.artifact_name }}
          ASSET: ${{ matrix.asset_name }}
        run: cp "target/release/$ARTIFACT" "dist/$ASSET"
      - name: Copy artifact (Windows)
        if: runner.os == 'Windows'
        run: Copy-Item "target\release\${{ matrix.artifact_name }}" "dist\${{ matrix.asset_name
          }}"
        shell: pwsh
      - name: Upload artifact
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f
        with:
          name: release-artifacts-${{ matrix.target }}
          path: dist/${{ matrix.asset_name }}
          retention-days: 7
          include-hidden-files: false
  rust-ci:
    name: Rust CI (PR consolidated)
    timeout-minutes: 5
    runs-on: ubuntu-latest
    needs:
      - changes
      - classify
      - lint
      - test-linux
      - test-cross
      - validate
      - audit
      - golden-tests
      - coverage
      - release-build
    if: always()
    steps:
      - name: Evaluate Required Checks
        env:
          IS_DRAFT: ${{ needs.classify.outputs.is_draft }}
          IS_BOT: ${{ needs.classify.outputs.is_bot }}
          RUN_FULL: ${{ needs.classify.outputs.run_full }}
          RUN_SIMPLIFIED: ${{ needs.classify.outputs.run_simplified }}
          LINT_RESULT: ${{ needs.lint.result }}
          TEST_LINUX_RESULT: ${{ needs.test-linux.result }}
          TEST_CROSS_RESULT: ${{ needs.test-cross.result }}
          VALIDATE_RESULT: ${{ needs.validate.result }}
          AUDIT_RESULT: ${{ needs.audit.result }}
          GOLDEN_RESULT: ${{ needs.golden-tests.result }}
          COVERAGE_RESULT: ${{ needs.coverage.result }}
          RELEASE_BUILD_RESULT: ${{ needs.release-build.result }}
        run: "echo \"=== PR Classification ===\"\necho \"Is Draft: $IS_DRAFT | Is\
          \ Bot: $IS_BOT\"\necho \"Run Full: $RUN_FULL | Run Simplified: $RUN_SIMPLIFIED\"\
          \necho \"\"\necho \"=== Job Results ===\"\necho \"Lint:          $LINT_RESULT\"\
          \necho \"Test Linux:    $TEST_LINUX_RESULT\"\necho \"Test Cross:    $TEST_CROSS_RESULT\"\
          \necho \"Validate:      $VALIDATE_RESULT\"\necho \"Audit:         $AUDIT_RESULT\"\
          \necho \"Golden:        $GOLDEN_RESULT\"\necho \"Coverage:      $COVERAGE_RESULT\"\
          \necho \"Release Build: $RELEASE_BUILD_RESULT\"\necho \"\"\n\nif [[ \"$RUN_SIMPLIFIED\"\
          \ == \"true\" ]]; then\n  echo \"=== Simplified Suite Policy (Draft/Bot\
          \ PR) ===\"\n  FAILED=0\n  for job in LINT_RESULT TEST_LINUX_RESULT VALIDATE_RESULT;\
          \ do\n    result=\"${!job}\"\n    if [[ \"$result\" != \"success\" && \"\
          $result\" != \"skipped\" ]]; then\n      echo \"[FAIL] $job: $result\"\n\
          \      FAILED=1\n    fi\n  done\n  if [[ $FAILED -eq 1 ]]; then\n    echo\
          \ \"[FAIL] Simplified checks failed\"\n    exit 1\n  fi\n  echo \"[OK] Simplified\
          \ checks passed\"\n  exit 0\nfi\n\nif [[ \"$RUN_FULL\" == \"true\" ]]; then\n\
          \  echo \"=== Full Suite Policy (Human Ready PR) ===\"\n  FAILED=0\n  for\
          \ job in LINT_RESULT TEST_LINUX_RESULT TEST_CROSS_RESULT \\\n          \
          \   VALIDATE_RESULT AUDIT_RESULT GOLDEN_RESULT COVERAGE_RESULT \\\n    \
          \         RELEASE_BUILD_RESULT; do\n    result=\"${!job}\"\n    if [[ \"\
          $result\" != \"success\" && \"$result\" != \"skipped\" ]]; then\n      echo\
          \ \"[FAIL] $job: $result\"\n      FAILED=1\n    fi\n  done\n\n  if [[ $FAILED\
          \ -eq 1 ]]; then\n    echo \"[FAIL] Full suite check failed\"\n    exit\
          \ 1\n  fi\n\n  echo \"[OK] Full suite - all required checks passed\"\n \
          \ exit 0\nfi\n\necho \"[FAIL] Unexpected classification state\"\nexit 1\n"
