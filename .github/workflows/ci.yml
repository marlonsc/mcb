name: CI

permissions:
  contents: read

on:
  push:
    branches: ["main", "feat/**"]
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review, converted_to_draft]
    branches: ["main"]
  workflow_dispatch:


env:
  CARGO_TERM_COLOR: always
  MCB_RUN_DOCKER_INTEGRATION_TESTS: "0"

jobs:
  changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read
    outputs:
      src: ${{ steps.filter.outputs.src }}
      docs: ${{ steps.filter.outputs.docs }}
      ci: ${{ steps.filter.outputs.ci }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            src:
              - 'src/**'
              - 'crates/**'
              - 'tests/**'
              - 'Cargo.toml'
              - 'Cargo.lock'
            docs:
              - 'docs/**'
              - 'scripts/docs/**'
            ci:
              - '.github/workflows/ci.yml'
              - '.github/setup-ci.sh'
              - 'Makefile'
              - 'make/*.mk'

  classify:
    name: Classify PR
    needs: [changes]
    runs-on: ubuntu-latest
    outputs:
      run_full: ${{ steps.classify.outputs.run_full }}
      run_simplified: ${{ steps.classify.outputs.run_simplified }}
    steps:
      - name: Classify PR Type
        id: classify
        run: |
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            if [[ "${{ github.event.pull_request.draft }}" == "true" ]]; then
               echo "run_full=false" >> "$GITHUB_OUTPUT"
               echo "run_simplified=true" >> "$GITHUB_OUTPUT"
            else
               echo "run_full=true" >> "$GITHUB_OUTPUT"
               echo "run_simplified=false" >> "$GITHUB_OUTPUT"
            fi
          else
            echo "run_full=true" >> "$GITHUB_OUTPUT"
            echo "run_simplified=false" >> "$GITHUB_OUTPUT"
          fi

  lint:
    name: Lint (Rust 2024)
    needs: [changes, classify]
    if: |
      (needs.changes.outputs.src == 'true' || needs.changes.outputs.ci == 'true') &&
      (needs.classify.outputs.run_full == "true" || needs.classify.outputs.run_simplified == 'true')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          persist-credentials: false
          submodules: recursive
      - run: bash .github/setup-ci.sh
      - uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy
      - uses: Swatinem/rust-cache@v2
        with:
          shared-key: ci-ubuntu-stable
          save-if: true
      - run: make lint MCB_CI=1

  test-linux:
    name: Test (ubuntu-latest, Rust stable)
    needs: [changes, classify, lint]
    if: |
      (needs.changes.outputs.src == 'true' || needs.changes.outputs.ci == 'true') &&
      (needs.classify.outputs.run_full == "true" || needs.classify.outputs.run_simplified == 'true')
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v4
        with:
          persist-credentials: false
          submodules: recursive
      - run: bash .github/setup-ci.sh
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
        with:
          shared-key: ci-ubuntu-stable
          save-if: false
      - name: Startup Smoke (DDL/Init)
        run: make test SCOPE=startup THREADS=4
      - name: Full Test Suite
        run: make test THREADS=4

  rust-ci:
    name: Rust CI (PR consolidated)
    timeout-minutes: 5
    runs-on: ubuntu-latest
    needs:
      - lint
      - test-linux
    if: always()
    steps:
      - name: Evaluate Required Checks
        env:
          LINT_RESULT: ${{ needs.lint.result }}
          TEST_LINUX_RESULT: ${{ needs.test-linux.result }}
        run: |
          if [[ "$LINT_RESULT" == "failure" || "$TEST_LINUX_RESULT" == "failure" ]]; then
            exit 1
          fi
          exit 0
