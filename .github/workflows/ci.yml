---
# =============================================================================
# CI Pipeline
# =============================================================================
# Uses same Makefile verbs as local development
# Rust 2024 edition lints enabled via CI_MODE=1
# =============================================================================

name: CI

permissions:
  contents: "read"

on: # yamllint disable-line rule:truthy
  push:
    branches:
      - main
      - develop
    paths:
      - "src/**"
      - "crates/**"
      - "tests/**"
      - "Cargo.toml"
      - "Cargo.lock"
      - ".github/workflows/ci.yml"
      - ".github/setup-ci.sh"
  pull_request:
    branches:
      - main
      - develop
    paths:
      - "src/**"
      - "crates/**"
      - "tests/**"
      - "Cargo.toml"
      - "Cargo.lock"
      - ".github/workflows/ci.yml"
      - ".github/setup-ci.sh"

concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.ref }}
  cancel-in-progress: true

env:
  CARGO_TERM_COLOR: always
  MCB_RUN_DOCKER_INTEGRATION_TESTS: "0"

jobs:
  lint:
    name: Lint (Rust 2024)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          persist-credentials: false
      - run: bash .github/setup-ci.sh
      - uses: dtolnay/rust-toolchain@4be9e76fd7c4901c61fb841f559994984270fce7 # stable
        with:
          components: rustfmt, clippy
      - uses: Swatinem/rust-cache@779680da715d629ac1d338a641029a2f4372abb5 # v2.8.2
      - run: make lint CI_MODE=1

  test-pr:
    name: Test (PR - Stable)
    if: github.event_name == 'pull_request'
    needs: [lint]
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          persist-credentials: false
      - run: bash .github/setup-ci.sh
      - uses: dtolnay/rust-toolchain@4be9e76fd7c4901c61fb841f559994984270fce7 # stable
      - uses: Swatinem/rust-cache@779680da715d629ac1d338a641029a2f4372abb5 # v2.8.2
      - run: make test TEST_THREADS=4

  startup-smoke:
    name: Startup Smoke (DDL/Init)
    needs: [lint]
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          persist-credentials: false
      - run: bash .github/setup-ci.sh
      - uses: dtolnay/rust-toolchain@4be9e76fd7c4901c61fb841f559994984270fce7 # stable
      - uses: Swatinem/rust-cache@779680da715d629ac1d338a641029a2f4372abb5 # v2.8.2
      - run: make test-startup

  test-main:
    name: Test (Main - ${{ matrix.rust }})
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    needs: [lint]
    runs-on: ubuntu-latest
    timeout-minutes: 30
    strategy:
      matrix:
        rust: [stable, beta]
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          persist-credentials: false
      - run: bash .github/setup-ci.sh
      - uses: dtolnay/rust-toolchain@4be9e76fd7c4901c61fb841f559994984270fce7 # master
        with:
          toolchain: ${{ matrix.rust }}
      - uses: Swatinem/rust-cache@779680da715d629ac1d338a641029a2f4372abb5 # v2.8.2
      - run: make test TEST_THREADS=4

  validate:
    name: Architecture Validation
    needs: [lint, startup-smoke]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          persist-credentials: false
      - run: bash .github/setup-ci.sh
      - uses: dtolnay/rust-toolchain@4be9e76fd7c4901c61fb841f559994984270fce7 # stable
      - uses: Swatinem/rust-cache@779680da715d629ac1d338a641029a2f4372abb5 # v2.8.2
      - run: make validate STRICT=1
      - name: Check Provider Traits Location
        run: |
          VIOLATIONS=$(
            grep -r "use mcb_application::ports::providers" \
              crates/mcb-providers/src/ 2>/dev/null || true
          )
          if [ -n "$VIOLATIONS" ]; then
            echo "VIOLATION: Provider traits should be imported from mcb-domain"
            echo "$VIOLATIONS"
            exit 1
          fi

  golden-tests:
    name: Golden Acceptance Tests
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    needs: [test-main]
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          persist-credentials: false
      - run: bash .github/setup-ci.sh
      - uses: dtolnay/rust-toolchain@4be9e76fd7c4901c61fb841f559994984270fce7 # stable
      - uses: Swatinem/rust-cache@779680da715d629ac1d338a641029a2f4372abb5 # v2.8.2
      - run: make test SCOPE=golden TEST_THREADS=2

  audit:
    name: Security Audit
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          persist-credentials: false
      - run: bash .github/setup-ci.sh --install-audit
      - uses: dtolnay/rust-toolchain@4be9e76fd7c4901c61fb841f559994984270fce7 # stable
      - uses: Swatinem/rust-cache@779680da715d629ac1d338a641029a2f4372abb5 # v2.8.2
      - run: make audit

  docs:
    name: Documentation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          persist-credentials: false
      - run: bash .github/setup-ci.sh
      - uses: dtolnay/rust-toolchain@4be9e76fd7c4901c61fb841f559994984270fce7 # stable
      - uses: Swatinem/rust-cache@779680da715d629ac1d338a641029a2f4372abb5 # v2.8.2
      - run: make docs

  coverage:
    name: Coverage
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    needs: [test-main]
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          persist-credentials: false
      - run: bash .github/setup-ci.sh --install-coverage
      - uses: dtolnay/rust-toolchain@4be9e76fd7c4901c61fb841f559994984270fce7 # stable
      - uses: Swatinem/rust-cache@779680da715d629ac1d338a641029a2f4372abb5 # v2.8.2
      - run: make coverage LCOV=1 TEST_THREADS=4
      - uses: codecov/codecov-action@671740ac38dd9b0130fbe1cec585b89eea48d3de # v5.5.2
        with:
          files: ./coverage/lcov.info
          fail_ci_if_error: false

  release-build:
    name: Release (${{ matrix.target }})
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    needs: [test-main, validate]
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
          - os: macos-latest
            target: x86_64-apple-darwin
          - os: windows-latest
            target: x86_64-pc-windows-msvc
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          persist-credentials: false
      - run: bash .github/setup-ci.sh
      - uses: dtolnay/rust-toolchain@4be9e76fd7c4901c61fb841f559994984270fce7 # stable
        with:
          targets: ${{ matrix.target }}
      - uses: Swatinem/rust-cache@779680da715d629ac1d338a641029a2f4372abb5 # v2.8.2
      - run: make build RELEASE=1
      - uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: mcb-${{ matrix.target }}
          path: >-
            target/release/mcb${{ matrix.os == 'windows-latest' &&
            '.exe' || '' }}
