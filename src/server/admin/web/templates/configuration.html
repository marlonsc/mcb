{% extends "base.html" %}
{% import "icons.html" as icons %}
{% block title %}Configuration - MCP Context Browser{% endblock %}

{% block content %}
<div x-data="config()" x-init="init()" class="space-y-6">
    <div class="page-header">
        <div>
            <h1 class="page-title">Configuration Management</h1>
            <p class="page-description">{{ page_description }}</p>
        </div>
        <div class="page-actions">
            <button @click="exportConfig()" class="btn btn-secondary">Export Config</button>
            <button @click="applyChanges()" class="btn btn-primary">Apply Changes</button>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
        <div class="lg:col-span-2 space-y-6">
            <!-- Providers -->
            <div class="card">
                <div class="card-header">
                    <h3 class="font-medium flex items-center gap-2">
                        {{ icons::icon(name="providers", class="icon-sm") }}
                        Provider Configuration
                    </h3>
                </div>
                <div class="card-body space-y-4">
                    <div>
                        <label class="input-label">Embedding Provider</label>
                        <select x-model="form.embedding_provider" class="input">
                            <option value="openai">OpenAI</option>
                            <option value="ollama">Ollama</option>
                            <option value="voyageai">VoyageAI</option>
                            <option value="gemini">Gemini</option>
                            <option value="fastembed">FastEmbed</option>
                        </select>
                    </div>
                    <div>
                        <label class="input-label">Vector Store Provider</label>
                        <select x-model="form.vector_store_provider" class="input">
                            <option value="milvus">Milvus</option>
                            <option value="pinecone">Pinecone</option>
                            <option value="qdrant">Qdrant</option>
                            <option value="in-memory">In-Memory</option>
                            <option value="filesystem">Filesystem</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- System -->
            <div class="card">
                <div class="card-header">
                    <h3 class="font-medium flex items-center gap-2">
                        {{ icons::icon(name="config", class="icon-sm") }}
                        System Configuration
                    </h3>
                </div>
                <div class="card-body">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="input-label">Metrics Interval (s)</label>
                            <input type="number" x-model="form.metrics_interval" class="input">
                        </div>
                        <div>
                            <label class="input-label">Cache Max Size (MB)</label>
                            <input type="number" x-model="form.cache_max_size" class="input">
                        </div>
                        <div>
                            <label class="input-label">Database Pool Size</label>
                            <input type="number" x-model="form.db_pool_size" class="input">
                        </div>
                        <div>
                            <label class="input-label">Chunk Size</label>
                            <input type="number" x-model="form.chunk_size" class="input">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Security -->
            <div class="card">
                <div class="card-header">
                    <h3 class="font-medium flex items-center gap-2">
                        {{ icons::icon(name="lock", class="icon-sm") }}
                        Security Configuration
                    </h3>
                </div>
                <div class="card-body space-y-4">
                    <label class="flex items-center gap-2">
                        <input type="checkbox" x-model="form.enable_auth" class="checkbox">
                        <span>Enable Authentication</span>
                    </label>
                    <label class="flex items-center gap-2">
                        <input type="checkbox" x-model="form.enable_rate_limiting" class="checkbox">
                        <span>Enable Rate Limiting</span>
                    </label>
                    <div>
                        <label class="input-label">Max Requests per Minute</label>
                        <input type="number" x-model="form.max_requests_per_minute" class="input">
                    </div>
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="space-y-6">
            <div class="card">
                <div class="card-header">
                    <h3 class="font-medium flex items-center gap-2">
                        {{ icons::icon(name="clock", class="icon-sm") }}
                        Recent Changes
                    </h3>
                </div>
                <template x-if="history.length === 0">
                    <div class="card-body text-center text-muted">No recent changes</div>
                </template>
                <template x-for="change in history" :key="change.id">
                    <div class="card-body card-divider">
                        <p class="text-sm font-medium" x-text="change.path"></p>
                        <p class="text-xs text-muted" x-text="change.change_type"></p>
                        <p class="text-xs text-muted" x-text="fmt.date(change.timestamp) + ' by ' + change.user"></p>
                    </div>
                </template>
            </div>

            <div class="card">
                <div class="card-header">
                    <h3 class="font-medium flex items-center gap-2">
                        {{ icons::icon(name="check-circle", class="icon-sm") }}
                        Configuration Validation
                    </h3>
                </div>
                <div class="card-body">
                    <button @click="validate()" class="btn btn-primary w-full">Validate Configuration</button>
                    <div x-show="validation.message" x-cloak class="mt-4 alert text-sm"
                         :class="css.alertClass(validation.valid ? 'success' : 'danger')"
                         x-text="validation.message"></div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function config() {
    return {
        form: {
            embedding_provider: '{{ configuration.providers.embedding.provider | default(value="fastembed") }}',
            vector_store_provider: '{{ configuration.providers.vector_store.provider | default(value="milvus") }}',
            metrics_interval: {{ configuration.metrics.collection_interval | default(value=30) }},
            cache_max_size: {{ configuration.cache.max_size_mb | default(value=1024) }},
            db_pool_size: {{ configuration.database.pool_size | default(value=10) }},
            chunk_size: {{ configuration.indexing.chunk_size | default(value=1000) }},
            enable_auth: {{ configuration.security.enable_auth | default(value=false) }},
            enable_rate_limiting: {{ configuration.security.rate_limiting | default(value=false) }},
            max_requests_per_minute: {{ configuration.security.max_requests_per_minute | default(value=60) }}
        },
        history: [],
        validation: { valid: null, message: '' },

        async init() { await this.loadHistory(); },

        async loadHistory() {
            try {
                const { data } = await API.get('/admin/configuration/history?limit=10');
                this.history = data || [];
            } catch (e) { console.error('Failed to load history:', e); }
        },

        async applyChanges() {
            try {
                await API.put('/admin/configuration', {
                    'providers.embedding.provider': this.form.embedding_provider,
                    'providers.vector_store.provider': this.form.vector_store_provider,
                    'metrics.collection_interval': parseInt(this.form.metrics_interval),
                    'cache.max_size_mb': parseInt(this.form.cache_max_size),
                    'database.pool_size': parseInt(this.form.db_pool_size),
                    'indexing.chunk_size': parseInt(this.form.chunk_size),
                    'security.enable_auth': this.form.enable_auth,
                    'security.rate_limiting': this.form.enable_rate_limiting,
                    'security.max_requests_per_minute': parseInt(this.form.max_requests_per_minute)
                });
                toast.success('Configuration updated');
                await this.loadHistory();
            } catch (e) { toast.error(e.message); }
        },

        async exportConfig() {
            try {
                const { data } = await API.get('/admin/configuration');
                const el = document.createElement('a');
                el.href = 'data:text/json;charset=utf-8,' + encodeURIComponent(JSON.stringify(data, null, 2));
                el.download = 'configuration.json';
                el.click();
                toast.success('Configuration exported');
            } catch (e) { toast.error(e.message); }
        },

        async validate() {
            try {
                const { data } = await API.post('/admin/configuration/validate', this.form);
                const errors = data || [];
                this.validation = errors.length === 0
                    ? { valid: true, message: 'Configuration is valid' }
                    : { valid: false, message: errors.join(', ') };
            } catch (e) {
                this.validation = { valid: false, message: e.message };
            }
        }
    };
}
</script>
{% endblock %}
