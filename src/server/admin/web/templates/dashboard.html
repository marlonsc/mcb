{% extends "base.html" %}
{% import "icons.html" as icons %}
{% block title %}Dashboard - MCP Context Browser{% endblock %}

{% block content %}
<div x-data="dashboard({{ vm_json | safe }})" x-init="init()" class="space-y-6">
    <!-- Header -->
    <div class="page-header">
        <div>
            <h1 class="page-title">System Dashboard</h1>
            <p class="page-description">
                <span x-show="isOnline" class="text-success">Live</span>
                <span x-show="!isOnline" class="text-danger">Offline</span>
            </p>
        </div>
        <div class="page-actions">
            <label class="flex items-center gap-2 text-sm">
                <input type="checkbox" x-model="autoRefresh" class="checkbox">
                Auto-refresh
            </label>
            <button @click="refresh()" :disabled="loading" class="btn btn-primary">
                <span x-show="loading" class="spinner"></span>
                <span x-text="loading ? 'Refreshing...' : 'Refresh'"></span>
            </button>
        </div>
    </div>

    <!-- Metrics Grid -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
        <!-- Status -->
        <div class="card card-body metric-card">
            <div class="icon-box icon-box-md icon-box-success">{{ icons::icon(name="check-circle") }}</div>
            <div class="metric-content">
                <div class="metric-label">System Status</div>
                <div class="metric-value" x-text="health.status"></div>
                <div class="metric-subtext">Uptime: <span x-text="fmt.duration(health.uptime)"></span></div>
            </div>
        </div>

        <!-- Providers -->
        <div class="card card-body metric-card">
            <div class="icon-box icon-box-md icon-box-primary">{{ icons::icon(name="monitor") }}</div>
            <div class="metric-content">
                <div class="metric-label">Providers</div>
                <div class="metric-value" x-text="active_providers + ' active'"></div>
                <div class="metric-subtext" x-text="'of ' + total_providers + ' total'"></div>
            </div>
        </div>

        <!-- Indexes -->
        <div class="card card-body metric-card">
            <div class="icon-box icon-box-md icon-box-warning">{{ icons::icon(name="database") }}</div>
            <div class="metric-content">
                <div class="metric-label">Indexes</div>
                <div class="metric-value" x-text="active_indexes + ' active'"></div>
                <div class="metric-subtext" x-text="fmt.num(total_documents) + ' documents'"></div>
            </div>
        </div>

        <!-- Performance -->
        <div class="card card-body metric-card">
            <div class="icon-box icon-box-md icon-box-danger">{{ icons::icon(name="bolt") }}</div>
            <div class="metric-content">
                <div class="metric-label">Performance</div>
                <div class="metric-value" x-text="cpu_usage + '% CPU'"></div>
                <div class="metric-subtext" x-text="memory_usage + '% Memory'"></div>
            </div>
        </div>
    </div>

    <!-- Charts -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
        <div class="card">
            <div class="card-header"><h3 class="font-medium">System Metrics</h3></div>
            <div class="card-body"><canvas id="metrics-chart" class="h-64"></canvas></div>
        </div>
        <div class="card">
            <div class="card-header"><h3 class="font-medium">Query Performance</h3></div>
            <div class="card-body"><canvas id="query-chart" class="h-64"></canvas></div>
        </div>
    </div>

    <!-- Activity -->
    <div class="card">
        <div class="card-header">
            <h3 class="font-medium">Recent Activity</h3>
            <button @click="refreshActivity()" class="btn btn-ghost btn-sm">Refresh</button>
        </div>
        <template x-if="activities.length === 0">
            <div class="empty-state">
                <p class="empty-state-text">No recent activity</p>
            </div>
        </template>
        <template x-for="a in activities" :key="a.id">
            <div class="card-body card-divider flex items-center gap-3">
                <div class="status-dot" :class="a.dotClass"></div>
                <div class="flex-1">
                    <p class="text-sm font-medium" x-text="a.message"></p>
                    <p class="text-xs text-muted" x-text="a.timestamp"></p>
                </div>
            </div>
        </template>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function dashboard(serverData) {
    const vm = serverData || {};
    const m = vm.metrics || {};
    const p = vm.providers || {};
    const i = vm.indexes || {};
    const h = vm.system_health || {};

    return {
        active_providers: p.active_count || 0,
        total_providers: p.total_count || 0,
        active_indexes: i.active_count || 0,
        total_documents: i.total_documents || 0,
        cpu_usage: m.cpu_usage_formatted || '0',
        memory_usage: m.memory_usage_formatted || '0',
        loading: false,
        isOnline: true,
        autoRefresh: true,
        health: { status: h.status || 'healthy', uptime: h.uptime_seconds || 0 },
        activities: (vm.activities || []).map(a => ({
            id: a.id, message: a.message,
            timestamp: a.timestamp_relative || a.timestamp,
            dotClass: { error: 'status-dot-danger', warning: 'status-dot-warning', success: 'status-dot-success' }[a.level] || 'status-dot-primary'
        })),

        init() {
            this.initCharts();
            setInterval(() => { if (this.autoRefresh && !this.loading) this.refresh(); }, 10000);
        },

        async refresh() {
            this.loading = true;
            try {
                const { data } = await API.get('/admin/dashboard/metrics');
                this.active_providers = data.active_providers;
                this.total_providers = data.total_providers;
                this.active_indexes = data.active_indexes;
                this.total_documents = data.total_documents;
                this.cpu_usage = data.cpu_usage.toFixed(1);
                this.memory_usage = data.memory_usage.toFixed(1);
                this.health = data.health;
                this.isOnline = true;
            } catch (e) {
                this.isOnline = false;
                toast.error(e.message);
            }
            this.loading = false;
        },

        async refreshActivity() {
            try {
                const { data } = await API.get('/admin/activities?limit=10');
                this.activities = data.map(a => ({
                    id: a.id, message: a.message,
                    timestamp: fmt.relative(a.timestamp),
                    dotClass: { error: 'status-dot-danger', warning: 'status-dot-warning', success: 'status-dot-success' }[a.level] || 'status-dot-primary'
                }));
            } catch (e) { toast.error(e.message); }
        },

        initCharts() {
            const metricsCtx = document.getElementById('metrics-chart');
            const queryCtx = document.getElementById('query-chart');
            if (metricsCtx) new Chart(metricsCtx, {
                type: 'line',
                data: { labels: ['now'], datasets: [
                    { label: 'CPU %', data: [parseFloat(this.cpu_usage)], borderColor: '#3b82f6', fill: false },
                    { label: 'Memory %', data: [parseFloat(this.memory_usage)], borderColor: '#10b981', fill: false }
                ]},
                options: { responsive: true, maintainAspectRatio: false, scales: { y: { max: 100 } } }
            });
            if (queryCtx) new Chart(queryCtx, {
                type: 'doughnut',
                data: { labels: ['Search', 'Index', 'Status'], datasets: [{ data: [45, 30, 25], backgroundColor: ['#3b82f6', '#10b981', '#f59e0b'] }] },
                options: { responsive: true, maintainAspectRatio: false }
            });
        }
    };
}
</script>
{% endblock %}
