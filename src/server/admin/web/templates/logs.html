{% extends "base.html" %}
{% import "icons.html" as icons %}
{% block title %}Logs - MCP Context Browser{% endblock %}

{% block content %}
<div x-data="logs()" x-init="init()" class="space-y-6">
    <div class="page-header">
        <div>
            <h1 class="page-title">System Logs</h1>
            <p class="page-description">{{ page_description }}</p>
        </div>
        <div class="page-actions">
            <button @click="exportLogs()" class="btn btn-secondary">Export Logs</button>
            <button @click="refresh()" class="btn btn-primary">Refresh</button>
        </div>
    </div>

    <!-- Stats -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
        <div class="card card-body metric-card">
            <div class="icon-box icon-box-md icon-box-primary">{{ icons::icon(name="document") }}</div>
            <div class="metric-content">
                <div class="metric-label">Total Entries</div>
                <div class="metric-value" x-text="fmt.num(stats.total)"></div>
            </div>
        </div>
        <div class="card card-body metric-card">
            <div class="icon-box icon-box-md icon-box-danger">{{ icons::icon(name="error") }}</div>
            <div class="metric-content">
                <div class="metric-label">Errors</div>
                <div class="metric-value" x-text="stats.errors"></div>
                <div class="metric-subtext" x-text="stats.errorRate + '% of total'"></div>
            </div>
        </div>
        <div class="card card-body metric-card">
            <div class="icon-box icon-box-md icon-box-warning">{{ icons::icon(name="warning") }}</div>
            <div class="metric-content">
                <div class="metric-label">Warnings</div>
                <div class="metric-value" x-text="stats.warnings"></div>
                <div class="metric-subtext" x-text="stats.warnRate + '% of total'"></div>
            </div>
        </div>
        <div class="card card-body metric-card">
            <div class="icon-box icon-box-md icon-box-success">{{ icons::icon(name="check-circle") }}</div>
            <div class="metric-content">
                <div class="metric-label">Active Modules</div>
                <div class="metric-value" x-text="stats.modules"></div>
            </div>
        </div>
    </div>

    <!-- Filters -->
    <div class="card">
        <div class="card-header"><h3 class="font-medium">Log Filters</h3></div>
        <div class="card-body">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                <div>
                    <label class="input-label">Log Level</label>
                    <select x-model="filter.level" class="input">
                        <option value="">All Levels</option>
                        <option value="ERROR">ERROR</option>
                        <option value="WARN">WARN</option>
                        <option value="INFO">INFO</option>
                        <option value="DEBUG">DEBUG</option>
                        <option value="TRACE">TRACE</option>
                    </select>
                </div>
                <div>
                    <label class="input-label">Module</label>
                    <input type="text" x-model="filter.module" placeholder="Filter by module..." class="input">
                </div>
                <div>
                    <label class="input-label">Message Contains</label>
                    <input type="text" x-model="filter.search" placeholder="Search in messages..." class="input">
                </div>
                <div>
                    <label class="input-label">Time Range</label>
                    <select x-model="filter.timeRange" class="input">
                        <option value="1h">Last Hour</option>
                        <option value="24h">Last 24 Hours</option>
                        <option value="7d">Last 7 Days</option>
                        <option value="30d">Last 30 Days</option>
                    </select>
                </div>
            </div>
            <div class="mt-4 flex justify-end">
                <button @click="loadLogs()" class="btn btn-secondary">Apply Filters</button>
            </div>
        </div>
    </div>

    <!-- Entries -->
    <div class="card">
        <div class="card-header"><h3 class="font-medium">Log Entries</h3></div>
        <table class="table">
            <thead>
                <tr>
                    <th>Timestamp</th>
                    <th>Level</th>
                    <th>Module</th>
                    <th>Message</th>
                    <th>File</th>
                    <th>Line</th>
                </tr>
            </thead>
            <tbody>
                <template x-if="loading">
                    <tr><td colspan="6" class="text-center p-4"><span class="spinner"></span> Loading...</td></tr>
                </template>
                <template x-if="!loading && entries.length === 0">
                    <tr><td colspan="6" class="text-center p-4 text-muted">No log entries found</td></tr>
                </template>
                <template x-for="entry in entries" :key="entry.id">
                    <tr>
                        <td x-text="fmt.datetime(entry.timestamp)"></td>
                        <td><span class="badge" :class="css.statusBadge(entry.level)" x-text="entry.level"></span></td>
                        <td x-text="entry.module || '-'"></td>
                        <td x-text="entry.message || '-'"></td>
                        <td x-text="entry.file || '-'"></td>
                        <td x-text="entry.line || '-'"></td>
                    </tr>
                </template>
            </tbody>
        </table>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function logs() {
    return {
        stats: { total: 0, errors: 0, warnings: 0, modules: 0, errorRate: '0', warnRate: '0' },
        filter: { level: '', module: '', search: '', timeRange: '24h' },
        entries: [],
        loading: true,

        async init() {
            await Promise.all([this.loadStats(), this.loadLogs()]);
        },

        async refresh() {
            await Promise.all([this.loadStats(), this.loadLogs()]);
            toast.success('Logs refreshed');
        },

        async loadStats() {
            try {
                const { data } = await API.get('/admin/logs/stats');
                const total = data.total_entries || 0;
                const errors = data.entries_by_level?.ERROR || 0;
                const warnings = data.entries_by_level?.WARN || 0;
                this.stats = {
                    total,
                    errors,
                    warnings,
                    modules: Object.keys(data.entries_by_module || {}).length,
                    errorRate: total > 0 ? (errors / total * 100).toFixed(1) : '0',
                    warnRate: total > 0 ? (warnings / total * 100).toFixed(1) : '0'
                };
            } catch (e) { toast.error(e.message); }
        },

        async loadLogs() {
            this.loading = true;
            try {
                const params = new URLSearchParams();
                if (this.filter.level) params.append('level', this.filter.level);
                if (this.filter.module) params.append('module', this.filter.module);
                if (this.filter.search) params.append('search', this.filter.search);
                if (this.filter.timeRange) params.append('time_range', this.filter.timeRange);

                const { data } = await API.get(`/admin/logs?${params.toString()}`);
                this.entries = data.entries || [];
            } catch (e) { toast.error(e.message); }
            this.loading = false;
        },

        async exportLogs() {
            try {
                const params = new URLSearchParams({ format: 'json' });
                if (this.filter.level) params.append('level', this.filter.level);
                if (this.filter.module) params.append('module', this.filter.module);
                if (this.filter.search) params.append('search', this.filter.search);

                const { data } = await API.get(`/admin/logs/export?${params.toString()}`);
                const el = document.createElement('a');
                el.href = 'data:text/json;charset=utf-8,' + encodeURIComponent(JSON.stringify(data, null, 2));
                el.download = `logs-${new Date().toISOString()}.json`;
                el.click();
                toast.success('Logs exported');
            } catch (e) { toast.error(e.message); }
        },

    };
}
</script>
{% endblock %}
